<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIRETORIA TÉCNICA DE ALMOXARIFADO E PATRIMÔNIO - SEMCAS</title>
    
    <!-- Scripts e Links -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos do Novo Design + Adaptações -->
    <style>
        :root {
            /* Cores principais SEMCAS */
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --light-blue: #60a5fa;
            
            /* Sistema de feedback */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;

            /* Estilos do painel antigo mantidos para consistência */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
            --card-hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }

        /* Header Institucional */
        .header-banner {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            color: white;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
        }
        .logo-img {
            height: 60px;
            width: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background: white;
            padding: 4px;
        }
        .main-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
            margin: 0;
        }
        .sub-title {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Navegação por Abas */
        .nav-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #475569; /* text-slate-600 */
            white-space: nowrap;
        }
        .nav-btn:hover {
            background-color: #f8fafc; /* hover:bg-slate-50 */
        }
        .nav-btn.active {
            color: var(--secondary-blue);
            border-bottom-color: var(--secondary-blue);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Alertas */
        .alert { padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid; }
        .alert-error { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .alert-success { background: #d1fae5; color: #166534; border-color: #a7f3d0; }
        .alert-warning { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .alert-info { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }

        /* Tabelas */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .table tbody tr:hover { background: #f9fafb; }

        /* Badges */
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: #d1fae5; color: #059669; }
        .badge-blue { background: #dbeafe; color: #2563eb; }
        .badge-yellow { background: #fef3c7; color: #d97706; }
        .badge-red { background: #fee2e2; color: #dc2626; }

        /* Animações */
        .loading-spinner {
            border: 5px solid #e5e7eb; /* slate-200 */
            border-top: 5px solid var(--secondary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsividade */
        @media (max-width: 768px) {
            .logo-container { flex-direction: column; text-align: center; gap: 0.75rem; }
            .main-title { font-size: 1.25rem; text-align: center; }
            .logo-img { height: 50px; }
            .sub-header-controls { flex-direction: column; gap: 0.5rem; align-items: stretch; }
            .sub-header-info { text-align: center; }
        }

        /* Estilos adicionais */
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltip-text { visibility: hidden; width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.875rem; line-height: 1.25rem; word-wrap: break-word; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: all 0.3s ease; max-height: 90vh; }
        .dashboard-list { max-height: 300px; overflow-y: auto; }
        .chart-container { position: relative; width: 100%; height: 350px; }

        /* --- ESTILOS MODERNIZADOS PARA ABA SEDE --- */
        .sede-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 2rem;
            align-items: flex-start;
        }
        .floor-nav {
            position: sticky;
            top: 160px;
        }
        .floor-nav-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .floor-nav-button:hover {
            background-color: #f8fafc;
            color: var(--primary-blue);
        }
        .floor-nav-button.active {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 14px rgba(30, 64, 175, 0.3);
        }
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .room-card-sede {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid var(--light-blue);
            display: flex;
            flex-direction: column;
        }
        .room-card-sede:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .room-card-sede.no-registry {
            border-left-color: var(--warning);
        }
        .room-card-header {
            padding: 1rem 1.25rem;
        }
        .room-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
        }
        .room-card-subtitle {
            font-size: 0.8rem;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
        }
        .room-card-body {
            padding: 0 1.25rem 1.25rem;
            flex-grow: 1;
        }
        .department-item-sede {
            padding: 0.75rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border-left: 2px solid #e2e8f0;
        }
        .department-name-sede {
            font-weight: 600;
            color: #334155;
            font-size: 0.9rem;
        }
        .department-registro-sede {
            font-size: 0.75rem;
            color: #64748b;
        }
        .department-observacao-sede {
             font-size: 0.75rem;
             color: #92400e; /* text-amber-700 */
             background-color: #fef3c7; /* bg-amber-100 */
             padding: 0.25rem 0.5rem;
             border-radius: 0.25rem;
             margin-top: 0.25rem;
             display: inline-block;
        }
        .search-box { 
            width: 100%; 
            padding: 10px 18px; 
            font-size: 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 50px; 
            outline: none; 
            transition: all 0.3s ease; 
            background: #f8fafc; 
        }
        .search-box:focus { 
            border-color: #667eea; 
            background: white; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        .filter-btn { 
            padding: 10px 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 50px; 
            background: white; 
            color: #64748b; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            white-space: nowrap; 
        }
        .filter-btn:hover { 
            border-color: #667eea; 
            color: #667eea; 
        }
        .filter-btn.active { 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            color: white; 
            border-color: transparent; 
        }
        
        @media (max-width: 1024px) {
            .sede-layout {
                grid-template-columns: 1fr;
            }
            .floor-nav {
                position: static;
                display: flex;
                overflow-x: auto;
                padding-bottom: 1rem;
                gap: 0.5rem;
            }
            .floor-nav-button {
                flex-shrink: 0;
            }
        }
        
        /* --- ESTILOS PARA NOVA ABA "TOTAL DE ITENS" --- */
        #total-itens-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1.5rem;
            align-items: flex-start;
        }
        #total-itens-list-container {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: calc(100vh - 300px);
            display: flex;
            flex-direction: column;
        }
        #total-itens-list {
            overflow-y: auto;
            flex-grow: 1;
        }
        .total-item-entry {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .total-item-entry:hover {
            background-color: #f8fafc;
        }
        .total-item-entry.selected {
            background-color: #eef2ff;
            border-left: 4px solid var(--primary-blue);
            font-weight: 600;
            color: var(--primary-blue);
        }
        #total-itens-details-container {
            position: sticky;
            top: 160px;
        }
        
        @media (max-width: 1024px) {
            #total-itens-layout {
                grid-template-columns: 1fr;
            }
            #total-itens-list-container {
                height: auto;
                max-height: 400px;
            }
            #total-itens-details-container {
                position: static;
                top: auto;
            }
        }
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body class="text-slate-700 antialiased">

    <!-- 1. Header Institucional -->
    <header class="header-banner sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="logo-container">
                <img src="https://www.saoluis.ma.gov.br/img/logo_mobile.png" alt="Logo Prefeitura de São Luís" class="logo-img" onerror="this.style.display='none'">
                <div class="title-container">
                    <h1 class="main-title">DIRETORIA TÉCNICA DE ALMOXARIFADO E PATRIMÔNIO</h1>
                    <p class="sub-title">SEMCAS - Secretaria Municipal da Criança e Assistência Social</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. Sub-Header de Controles -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center flex-wrap sub-header-controls">
                <div class="flex items-center space-x-4 sub-header-info">
                    <div class="bg-blue-500 text-white p-3 rounded-lg hidden sm:block">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10M18 20V4M6 20V16"/></svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-lg text-slate-800">Sistema de Patrimônio</h2>
                        <p class="text-sm text-slate-500">v.2.5 </p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <div id="connectionStatus" class="flex items-center gap-2"></div>
                    <p id="last-update-time" class="text-slate-500"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Sistema de Navegação -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky z-40 top-[92px] md:top-[88px]">
        <div class="container mx-auto px-4">
            <div class="flex space-x-1 overflow-x-auto">
                <button class="nav-btn" data-tab="dashboard">📊 Dashboard</button>
                <button class="nav-btn" data-tab="patrimonio">💼 Patrimônio</button>
                <button class="nav-btn" data-tab="estoque">📦 Estoque</button>
                <button class="nav-btn" data-tab="total-itens">🔢 Total de Itens</button>
                <button class="nav-btn" data-tab="analise">🔍 Análise</button>
                <button class="nav-btn" data-tab="sede">🏢 Sede</button>
            </div>
        </div>
    </nav>

    <!-- 4. Conteúdo Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Conteúdo do Dashboard -->
        <div id="content-dashboard" class="hidden fade-in">
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card text-center">
                    <p class="text-sm text-slate-500 uppercase">Total de Itens</p>
                    <p id="kpi-total-itens" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm text-slate-500 uppercase">Unidades Mapeadas</p>
                    <p id="kpi-total-unidades" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm text-slate-500 uppercase">Itens Avariados</p>
                    <p id="kpi-total-avariados" class="text-4xl font-bold text-red-600 mt-2">0</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm text-slate-500 uppercase">Unidades em Atenção</p>
                    <p id="kpi-unidades-atencao" class="text-4xl font-bold text-yellow-500 mt-2">0</p>
                </div>
            </div>

            <!-- Charts and Lists -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 card">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Distribuição de Itens por Estado</h3>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="dashboardEstadoChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">⚠️ Top Unidades em Atenção</h3>
                    <div id="dashboard-attention-units-list" class="space-y-3 dashboard-list"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                 <div class="lg:col-span-2 card">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Top 10 Itens Novos</h3>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="dashboardTopItemsChart"></canvas>
                    </div>
                </div>
                <div class="card">
                     <h3 class="text-lg font-semibold text-slate-800 mb-4">💧 Unidades sem Bebedouro Funcional</h3>
                     <div id="dashboard-no-bebedouro-units-list" class="space-y-3 dashboard-list"></div>
                </div>
            </div>
        </div>

        <!-- Conteúdo do Patrimônio -->
        <div id="content-patrimonio" class="hidden fade-in">
             <div class="card mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="filtro-servico" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Tipo de Unidade</label>
                        <select id="filtro-servico" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="">TODOS</option>
                            <option value="conselho">CONSELHO</option>
                            <option value="cras">CRAS</option>
                            <option value="creas">CREAS</option>
                            <option value="externa">UNIDADE EXTERNA</option>
                            <option value="centro_pop">CENTRO POP</option>
                            <option value="abrigo">ABRIGO</option>
                            <option value="sede">SEDE</option>
                        </select>
                    </div>
                    <div>
                        <label for="open-unidade-modal-btn" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Unidade</label>
                        <button id="open-unidade-modal-btn" class="w-full p-2 border border-slate-300 rounded-lg bg-white text-left truncate disabled:opacity-50 disabled:cursor-not-allowed">
                            Selecione uma Unidade...
                        </button>
                    </div>
                    <div>
                        <label for="filtro-estado" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Estado</label>
                        <select id="filtro-estado" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                    <div>
                        <label for="filtro-doacao" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Origem</label>
                        <select id="filtro-doacao" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                            <option value="">TODAS</option>
                            <option value="sim">APENAS DOAÇÕES</option>
                            <option value="nao">APENAS PRÓPRIOS</option>
                        </select>
                    </div>
                    <div>
                        <label for="filtro-busca" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Buscar Item</label>
                        <input type="text" id="filtro-busca" placeholder="Ex: Cadeira, Mesa..." class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="w-full md:w-auto mt-4">
                    <button id="ver-resumo-geral-btn" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">VER INVENTÁRIO COMPLETO</button>
                </div>
            </div>
            <main id="main-content-area" class="mt-8"></main>
        </div>

        <!-- Conteúdo do Estoque -->
        <div id="content-estoque" class="hidden fade-in">
             <div class="card mb-8">
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4 items-end">
                     <div>
                        <label for="filtro-estoque-unidade" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Filtrar por Unidade</label>
                        <select id="filtro-estoque-unidade" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                    <div>
                        <label for="filtro-estoque-busca" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Buscar no Estoque</label>
                        <input type="text" id="filtro-estoque-busca" placeholder="Ex: Café, Papel A4..." class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                    </div>
                 </div>
            </div>
            <div class="card mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-800">TOP 10 ITENS EM ESTOQUE</h3>
                </div>
                <div class="chart-container" data-chart-name="estoqueBarChart"><canvas id="estoqueBarChart"></canvas></div>
            </div>
            <main id="main-content-estoque" class="mt-8"></main>
        </div>
        
        <!-- Conteúdo do Total de Itens (NOVO LAYOUT) -->
        <div id="content-total-itens" class="hidden fade-in">
            <div class="card mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="filtro-total-categoria" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Categoria (Tipo)</label>
                        <select id="filtro-total-categoria" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                    <div>
                        <label for="filtro-total-item" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Buscar por Descrição</label>
                        <input type="text" id="filtro-total-item" placeholder="Ex: Fogão, Cadeira..." class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="filtro-total-unidade" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Unidade</label>
                        <select id="filtro-total-unidade" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                    <div>
                        <label for="filtro-total-estado" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Estado</label>
                        <select id="filtro-total-estado" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                    </div>
                </div>
            </div>
            
            <div id="total-itens-summary" class="mb-6"></div>

            <main id="total-itens-layout">
                <div id="total-itens-list-container">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="font-semibold text-slate-800">Itens Agrupados</h3>
                        <p class="text-sm text-slate-500" id="total-itens-list-count">0 itens encontrados</p>
                    </div>
                    <div id="total-itens-list">
                        <!-- A lista de itens será renderizada aqui -->
                    </div>
                </div>
                <div id="total-itens-details-container">
                    <!-- Os detalhes do item selecionado aparecerão aqui -->
                </div>
            </main>
        </div>
        
        <!-- Conteúdo da Análise de Necessidades -->
        <div id="content-analise" class="hidden fade-in">
            <div class="card mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Análise de Necessidades Essenciais</h2>
                        <p class="text-slate-500 mt-1">Ferramenta para identificar a falta de itens essenciais (climatização e bebedouros) nas unidades.</p>
                    </div>
                </div>
                <div class="mt-6 border-t border-slate-200 pt-4">
                    <label for="analise-filter" class="block text-sm font-medium text-slate-600 mb-1 uppercase">Filtrar por Necessidade</label>
                    <select id="analise-filter" class="w-full max-w-xs p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                        <option value="todos">Todas as Necessidades</option>
                        <option value="bebedouro">Falta de Bebedouro</option>
                        <option value="climatizacao">Falta de Climatização</option>
                    </select>
                </div>
            </div>
            <div id="analise-summary" class="mb-6"></div>
            <main id="analise-results" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-8">
            </main>
        </div>

        <!-- Conteúdo da Estrutura da Sede -->
        <div id="content-sede" class="hidden fade-in">
            <div class="card mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <input type="text" class="search-box" id="searchBoxSede" placeholder="🔍 Pesquisar por setor, sala, ou tipo...">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium">Filtro:</label>
                        <button class="filter-btn active" id="filterAllSede">Todas</button>
                        <button class="filter-btn" id="filterNoRegistrySede">Sem Registro</button>
                    </div>
                </div>
            </div>

            <div class="sede-layout">
                <nav id="sede-floor-nav" class="floor-nav space-y-2">
                    <!-- Navegação dos andares será gerada aqui -->
                </nav>
                <div id="sede-rooms-container" class="room-grid">
                     <!-- Cards das salas serão gerados aqui -->
                </div>
            </div>

            <div class="no-results" id="noResultsSede" style="display: none;">
                <h3 class="text-2xl font-bold">❌ Nenhum resultado encontrado</h3>
                <p>Tente ajustar os termos da sua pesquisa ou filtros.</p>
            </div>
        </div>
    </main>

    <!-- 5. Rodapé -->
    <footer class="text-center mt-12 mb-6 text-sm text-slate-500">
        <p>Painel desenvolvido por: Jurandy </p>
        <p>Secretaria Municipal da Criança e Assistência Social (SEMCAS)</p>
    </footer>

    <!-- Modal de Seleção de Unidade -->
    <div id="unidade-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black/60 modal-overlay opacity-0"></div>
        <div class="modal-container bg-white w-full max-w-2xl rounded-lg shadow-2xl flex flex-col transform scale-95 opacity-0">
            <div class="flex items-center justify-between p-4 border-b border-slate-200">
                <h3 class="text-xl font-semibold text-slate-800">Selecionar Unidade</h3>
                <button id="close-modal-btn" class="p-2 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-4 border-b border-slate-200">
                <input type="text" id="unidade-search-input" placeholder="Pesquisar pelo nome da unidade..." class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <ul id="unidade-list-container" class="space-y-2"></ul>
            </div>
            <div class="flex justify-end p-4 border-t border-slate-200">
                <button id="clear-unidade-selection-btn" class="px-4 py-2 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300">Limpar Seleção</button>
            </div>
        </div>
    </div>

    <!-- Script Principal (Adaptado) -->
    <script type="text/javascript">
        // --- DADOS DA SEDE (INTEGRADO) ---
        /**
         * =================================================================
         * ESTRUTURA DE DADOS DA SEDE - SEMCAS
         * =================================================================
         * Este arquivo centraliza os dados da organização das salas e setores na Sede.
         * Para atualizar, basta editar as informações neste arquivo.
         */
        const sedeData = [
            // SUBSOLO
            { local: "SUBSOLO", sala: "SALA 1", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE ALMOXARIFADO E PATRIMÔNIO", registro: "140.32 - SUPERINTENDÊNCIA DE ADMINISTRAÇÃO", observacao: "" }] },
            { local: "SUBSOLO", sala: "SALA 2", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE ARQUIVO E PROTOCOLO", registro: "140.88 - DIRETORIA TÉCNICA DE ARQUIVO E PROTOCOLO", observacao: "" }] },
            { local: "SUBSOLO", sala: "SALA 3", tipo: "SALA INDIVIDUAL", setores: [{ nome: "SERVIÇOS GERAIS (LSL)", registro: "140.101 - SERVIÇOS GERAIS", observacao: "" }] },
            { local: "SUBSOLO", sala: "SALA 4", tipo: "SALA INDIVIDUAL", setores: [{ nome: "COORDENAÇÃO DE ADMINISTRAÇÃO E PATRIMÔNIO", registro: "140.1 - COORDENAÇÃO DE MATERIAL E PATRIMÔNIO", observacao: "" }] },
            { local: "SUBSOLO", sala: "SALA 5", tipo: "SALA INDIVIDUAL", setores: [{ nome: "ALMOXARIFADO", registro: "", observacao: "Precisa criar identificação no sistema." }] },
            { local: "SUBSOLO", sala: "SALA 6", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE LOGÍSTICA E TRANSPORTE", registro: "140.73 - COORDENAÇÃO DE SUPORTE E LOGÍSTICA / 140.82 - SETOR DE TRANSPORTE", observacao: "Confirmado como mesmo setor. Recomenda-se unificar no sistema (sugerido: manter 140.73)." }] },
            { local: "SUBSOLO", sala: "SALA 7", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE MANUTENÇÃO", registro: "140.96 - DIRETORIA TÉCNICA DE MANUTENÇÃO", observacao: "" }] },
            
            // TÉRREO
            { local: "TÉRREO", sala: "SALA 1", tipo: "SALA INDIVIDUAL", setores: [{ nome: "RECEPÇÃO", registro: "140.94 - RECEPÇÃO", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 2", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE CADASTRO ÚNICO E TRANSFERÊNCIA DE RENDA", registro: "140.29 - SUPERINTENDÊNCIA DE GESTÃO DE BENEFÍCIOS", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 3", tipo: "SALA CONJUNTA", setores: [
                { nome: "SUPERINTENDÊNCIA DE GESTÃO DE BENEFÍCIOS SOCIOASSISTENCIAIS E TRANSFERÊNCIA DE RENDA", registro: "140.29 - SUPERINTENDÊNCIA DE GESTÃO DE BENEFÍCIOS", observacao: "" },
                { nome: "COORDENAÇÃO DE CADASTRO ÚNICO E TRANSFERÊNCIA DE RENDA", registro: "140.29 - SUPERINTENDÊNCIA DE GESTÃO DE BENEFÍCIOS", observacao: "" }
            ]},
            { local: "TÉRREO", sala: "SALA 4", tipo: "SALA CONJUNTA", setores: [
                { nome: "COORDENAÇÃO DO SERVIÇO DE PROTEÇÃO E ATENDIMENTO ESPECIALIZADO À FAMÍLIA (PAEFI)", registro: "140.48 - COORDENAÇÃO DO PAEFI", observacao: "" },
                { nome: "SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL DE MÉDIA COMPLEXIDADE", registro: "140.76 - SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL DE MÉDIA COMPLEXIDADE", observacao: "" }
            ]},
            { local: "TÉRREO", sala: "SALA 5", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "COORDENAÇÃO DO SERVIÇO ESPECIALIZADO EM ABORDAGEM SOCIAL", registro: "140.93 - SERVIÇO ESPECIALIZADO EM ABORDAGEM SOCIAL", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 6", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "COORDENAÇÃO DE PROTEÇÃO PARA PESSOAS COM DEFICIÊNCIA E IDOSAS", registro: "140.99 - COORDENAÇÃO DE PROTEÇÃO PARA PESSOAS COM DEFICIÊNCIA E IDOSAS", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 7", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "AÇÕES ESTRATÉGICAS DO PROGRAMA DE ERRADICAÇÃO DO TRABALHO INFANTIL (AEPETI)", registro: "140.89 - AÇÕES ESTRATÉGICAS DO PROGRAMA DE ERRADICAÇÃO DO TRABALHO INFANTIL", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 8", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "COORDENAÇÃO DE PESSOAS EM SITUAÇÃO DE RUA", registro: "140.40 - COORDENAÇÃO DE PESSOAS EM SITUAÇÃO DE RUA", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 9", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "COORDENAÇÃO DO SERVIÇO DE PROTEÇÃO SOCIAL A ADOLESCENTES EM CUMPRIMENTO DE MEDIDAS SOCIOEDUCATIVAS", registro: "140.33 - COORDENAÇÃO DE MEDIDAS SOCIOEDUCATIVAS", observacao: "" }] },
            { local: "TÉRREO", sala: "SALA 10", tipo: "DIVIDIDA POR GESSO", setores: [{ nome: "MEDIDA SOCIOEDUCATIVA", registro: "140.33 - COORDENAÇÃO DE MEDIDAS SOCIOEDUCATIVAS", observacao: "" }] },

            // MEZANINO
            { local: "MEZANINO", sala: "SALA 1", tipo: "SALA INDIVIDUAL", setores: [{ nome: "COORDENAÇÃO DE BENEFÍCIOS SOCIOASSISTENCIAIS", registro: "140.44 - COORDENAÇÃO DE BENEFÍCIOS E AÇÕES SOCIOASSISTENCIAIS", observacao: "" }] },
            { local: "MEZANINO", sala: "SALA 2", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE INFORMÁTICA", registro: "140.79 - TECNOLOGIA DA INFORMAÇÃO", observacao: "" }] },
            { local: "MEZANINO", sala: "SALA 3", tipo: "SALA CONJUNTA", setores: [
                { nome: "SUPERINTENDÊNCIA DE ARTICULAÇÃO INSTITUCIONAL", registro: "140.31 / 140.77 - SUPERINTENDÊNCIA DE ARTICULAÇÃO INSTITUCIONAL", observacao: "Recomenda-se unificar no sistema (sugerido: manter 140.31)." },
                { nome: "COORDENAÇÃO E DIRETORIA DE AÇÕES AFIRMATIVAS E DIREITOS HUMANOS", registro: "140.41 - COORDENAÇÃO DE PROTEÇÃO E ARTICULAÇÃO DE POLÍTICA DE INCLUSÃO", observacao: "" }
            ]},
            { local: "MEZANINO", sala: "SALA 4", tipo: "SALA INDIVIDUAL", setores: [{ nome: "SECRETÁRIA ADJUNTA DE PROTEÇÃO SOCIAL", registro: "", observacao: "Precisa criar identificação no sistema." }] },
            { local: "MEZANINO", sala: "SALA 5", tipo: "SALA CONJUNTA", setores: [
                { nome: "ASSESSORIA TÉCNICA (ASTEC)", registro: "140.78 - ASSESSORIA TÉCNICA / COMUNICAÇÃO", observacao: "" },
                { nome: "PROGRAMA DE CAPACITAÇÃO DE DIRIGENTES (PROCAD)", registro: "140.36 - COORDENAÇÃO DE CAPACITAÇÃO", observacao: "" },
                { nome: "PROGRAMA CRIANÇA FELIZ (PCF)", registro: "", observacao: "Precisa criar identificação no sistema." }
            ]},
            
            // 1º ANDAR
            { local: "1º ANDAR", sala: "SALA 1", tipo: "SALA CONJUNTA", setores: [
                { nome: "SUPERINTENDÊNCIA DE GESTÃO DO SUAS", registro: "140.27 - SUPERINTENDÊNCIA DE GESTÃO DO SISTEMA ÚNICO DE ASSISTÊNCIA SOCIAL", observacao: "" },
                { nome: "COORDENAÇÃO DE REGULAÇÃO DO SUAS", registro: "140.27 - SUPERINTENDÊNCIA DE GESTÃO DO SISTEMA ÚNICO DE ASSISTÊNCIA SOCIAL", observacao: "" },
                { nome: "COORDENAÇÃO DA REDE SOCIOASSISTENCIAL PRIVADA", registro: "140.49 - COORDENAÇÃO DE ARTICULAÇÃO DA REDE DE PROTEÇÃO", observacao: "" }
            ]},
            { local: "1º ANDAR", sala: "SALA 2", tipo: "SALA CONJUNTA", setores: [
                { nome: "SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL ESPECIAL DE ALTA COMPLEXIDADE", registro: "140.26 - SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL ESPECIAL DE ALTA COMPLEXIDADE", observacao: "" },
                { nome: "COORDENAÇÃO DOS SERVIÇOS FAMILIAR E INSTITUCIONAL DE ACOLHIMENTO", registro: "140.46 - COORDENAÇÃO ACOLHIMENTO INSTITUCIONAL", observacao: "" }
            ]},
            { local: "1º ANDAR", sala: "SALA 3", tipo: "SALA CONJUNTA", setores: [
                { nome: "DIRETORIA TÉCNICA DE ACOLHIMENTO INSTITUCIONAL", registro: "140.46 - COORDENAÇÃO ACOLHIMENTO INSTITUCIONAL", observacao: "" },
                { nome: "DIRETORIA TÉCNICA DA CENTRAL DE ACOLHIMENTO", registro: "140.46 - COORDENAÇÃO ACOLHIMENTO INSTITUCIONAL", observacao: "" },
                { nome: "DIRETORIA TÉCNICA DE ACOLHIMENTO EM FAMÍLIA ACOLHEDORA", registro: "140.46 - COORDENAÇÃO ACOLHIMENTO INSTITUCIONAL", observacao: "Recomenda-se avaliar códigos separados para maior clareza." }
            ]},
            { local: "1º ANDAR", sala: "SALA 4", tipo: "SALA CONJUNTA", setores: [
                { nome: "PAIF - COORDENAÇÃO DO SERVIÇO DE PROTEÇÃO E ATENDIMENTO INTEGRAL À FAMÍLIA", registro: "140.4 - COORDENAÇÃO DO PAIF", observacao: "" },
                { nome: "SCFV - COORDENAÇÃO DO SERVIÇO DE CONVIVÊNCIA E FORTALECIMENTO DE VÍNCULOS", registro: "140.43 - COORDENAÇÃO DE CONVIVÊNCIA E FORTALECIMENTO", observacao: "" },
                { nome: "COORDENAÇÃO DO SERVIÇO DE PROTEÇÃO SOCIAL BÁSICA NO DOMICÍLIO", registro: "", observacao: "Precisa criar identificação no sistema." }
            ]},
            { local: "1º ANDAR", sala: "SALA 5", tipo: "SALA INDIVIDUAL", setores: [{ nome: "SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL BÁSICA", registro: "140.25 - SUPERINTENDÊNCIA DE PROTEÇÃO SOCIAL BÁSICA", observacao: "" }] },
            { local: "1º ANDAR", sala: "SALA 6", tipo: "SALA INDIVIDUAL", setores: [{ nome: "COORDENAÇÃO DE GESTÃO DO TRABALHO E EDUCAÇÃO PERMANENTE (COGETEP)", registro: "140.95 - COORDENAÇÃO DE GESTÃO DO TRABALHO E EDUCAÇÃO PERMANENTE", observacao: "" }] },
            { local: "1º ANDAR", sala: "SALA 7", tipo: "SALA INDIVIDUAL", setores: [{ nome: "COORDENAÇÃO DE RECURSOS HUMANOS", registro: "140.34 - COORDENAÇÃO DE RECURSOS HUMANOS", observacao: "Recomenda-se criar código separado para DIRETORIA TÉCNICA DE FOLHA DE PAGAMENTO." }] },
            { local: "1º ANDAR", sala: "SALA 8", tipo: "SALA INDIVIDUAL", setores: [{ nome: "DIRETORIA TÉCNICA DE FOLHA DE PAGAMENTO", registro: "140.34 - COORDENAÇÃO DE RECURSOS HUMANOS", observacao: "Recomenda-se criar código separado para evitar confusão com COORDENAÇÃO DE RECURSOS HUMANOS." }] },
            { local: "1º ANDAR", sala: "SALA 9", tipo: "SALA INDIVIDUAL", setores: [{ nome: "ASSESSORIA JURÍDICA", registro: "140.84 - SEMCAS - ASSESSORIA JURÍDICA", observacao: "" }] },
            { local: "1º ANDAR", sala: "SALA 10", tipo: "SALA CONJUNTA", setores: [
                { nome: "COORDENAÇÃO DE PLANEJAMENTO E VIGILÂNCIA SOCIOASSISTENCIAL", registro: "140.87 - COORDENAÇÃO DE PLANEJAMENTO E VIGILÂNCIA", observacao: "" },
                { nome: "SUPERINTENDÊNCIA E COORDENAÇÕES DE EXECUÇÃO ORÇAMENTÁRIA, FINANCEIRA E CONTABILIDADE", registro: "140.81 - COORDENAÇÃO DE EXECUÇÃO ORÇAMENTÁRIA E FINANCEIRA", observacao: "Recomenda-se avaliar código separado para PRESTAÇÃO DE CONTAS." },
                { nome: "DIRETORIA TÉCNICA DE GESTÃO DOS FUNDOS MUNICIPAIS", registro: "140.90 - FUNDO MUNICIPAL DE ASSISTÊNCIA SOCIAL / 140.91 - FUNDO MUNICIPAL DE DIREITO DA CRIANÇA E DO ADOLESCENTE / 140.92 - FUNDO MUNICIPAL DE DIREITO DO IDOSO", observacao: "" },
                { nome: "DIRETORIA TÉCNICA DE PRESTAÇÃO DE CONTAS", registro: "140.81 - COORDENAÇÃO DE EXECUÇÃO ORÇAMENTÁRIA E FINANCEIRA", observacao: "Recomenda-se avaliar código separado para evitar confusão." }
            ]},
            { local: "1º ANDAR", sala: "SALA 11", tipo: "SALA CONJUNTA", setores: [
                { nome: "GABINETE", registro: "140.85 - GABINETE", observacao: "" },
                { nome: "COMUNICAÇÃO", registro: "140.42 - COORDENAÇÃO E ASSESSORIA DE COMUNICAÇÃO", observacao: "" }
            ]},
            { local: "1º ANDAR", sala: "SALA 12", tipo: "SALA INDIVIDUAL", setores: [{ nome: "GABINETE DO SECRETÁRIO ADJUNTO DE ADMINISTRAÇÃO", registro: "140.74 - GABINETE DA SECRETÁRIA ADJUNTA DE GESTÃO", observacao: "" }] },
            { local: "1º ANDAR", sala: "SALA 13", tipo: "SALA INDIVIDUAL", setores: [{ nome: "COORDENAÇÃO DE CONTRATOS", registro: "140.2 - COORDENAÇÃO DE CONTRATOS E CONVÊNIOS / 140.86 - COORDENAÇÃO DE CONTRATOS", observacao: "Recomenda-se unificar no sistema (sugerido: manter 140.86)." }] },
            
            // 2º ANDAR
            { local: "2º ANDAR", sala: "SALA 1", tipo: "SALA INDIVIDUAL", setores: [{ nome: "CONSELHO MUNICIPAL DOS DIREITOS DA CRIANÇA E DO ADOLESCENTE (CMDCA)", registro: "140.70 - CONSELHO MUNICIPAL DOS DIREITOS DA CRIANÇA E DO ADOLESCENTE DE SÃO LUÍS", observacao: "" }] },
            { local: "2º ANDAR", sala: "SALA 2", tipo: "SALA INDIVIDUAL", setores: [{ nome: "CONSELHO MUNICIPAL DO IDOSO (CMDI)", registro: "140.71 - CONSELHO MUNICIPAL DO IDOSO", observacao: "" }] },
            { local: "2º ANDAR", sala: "SALA 3", tipo: "SALA INDIVIDUAL", setores: [{ nome: "CONSELHO MUNICIPAL DE ASSISTÊNCIA SOCIAL (CMAS)", registro: "140.69 - CONSELHO MUNICIPAL ASSISTÊNCIA SOCIAL", observacao: "" }] },
            { local: "2º ANDAR", sala: "SALA 4", tipo: "SALA INDIVIDUAL", setores: [{ nome: "CONSELHO MUNICIPAL DOS DIREITOS DA PESSOA COM DEFICIÊNCIA (CMDEF)", registro: "", observacao: "Precisa criar identificação no sistema." }] },
            { local: "2º ANDAR", sala: "SALA 6", tipo: "SALA INDIVIDUAL", setores: [{ nome: "AUDITÓRIO", registro: "140.97 - AUDITÓRIO", observacao: "" }] },
            
            // 3º ANDAR
            { local: "3º ANDAR", sala: "SALA 1", tipo: "SALA INDIVIDUAL", setores: [{ nome: "AUDITÓRIO", registro: "140.97 - AUDITÓRIO", observacao: "Repetido no 2º andar, sala 6. Verificar se é o mesmo espaço." }] },
            
            // SETORES PENDENTES DE LOCALIZAÇÃO
            { local: "PENDENTE", sala: "SETORES PENDENTES DE LOCALIZAÇÃO", tipo: "PENDENTE", setores: [
                { nome: "SUPERINTENDÊNCIA DE ENFRENTAMENTO À VIOLAÇÃO DE DIREITOS", registro: "140.30 - SUPERINTENDÊNCIA DE ENFRENTAMENTO À VIOLAÇÃO DE DIREITOS", observacao: "Localização na sede não confirmada." },
                { nome: "COORDENAÇÃO DE RESGATE E VIGILÂNCIA SOCIAL", registro: "140.45 - COORDENAÇÃO DE RESGATE E VIGILÂNCIA SOCIAL", observacao: "Localização na sede não confirmada." },
                { nome: "COORDENAÇÃO DE INCLUSÃO SOCIOPRODUTIVA", registro: "140.47 - COORDENAÇÃO DE INCLUSÃO SOCIOPRODUTIVA", observacao: "Localização na sede não confirmada." }
                
            ]}
        ];

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const googleSheetPatrimonioUrl = 'https://script.google.com/macros/s/AKfycbypxSVE9syiII4H4DumAfxWEgFm1AE7qLpuQgqHTNLMi4B7I8dWF0Het7V2Cd4_aL58Mg/exec';
        const googleSheetEstoqueUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtgMcUrrMlaEW0BvLD1466J1geRMzLkv6iZ5QpdY53BH6bc38SMinDvC1C-iI9RKHIcWqTjRf4ccdk/pub?output=csv';

        let allItems = [];
        let dadosOriginais = []; 
        let visaoAtiva = 'dashboard';
        let tituloDaVisao = 'Dashboard';
        let currentPage = 1;
        const itemsPerPage = 20;
        let estadoChartInstance, dashboardChartInstance, estoqueChartInstance;
        let allEstoqueItems = [];
        let selectedUnidadeValue = '';
        let analysisResults = [];
        let dashboardEstadoChartInstance, dashboardTopItemsChartInstance;


        // --- Referências de Elementos ---
        let filtroServicoEl, filtroEstadoEl, filtroBuscaEl, filtroDoacaoEl;
        let mainContentAreaEl, verResumoGeralBtn;
        let tableBodyEl, paginationControlsEl;
        let navButtons;
        let contentPanes;
        let mainContentEstoqueEl, filtroEstoqueUnidadeEl, filtroEstoqueBuscaEl;
        let filtroTotalCategoriaEl, filtroTotalItemEl, filtroTotalUnidadeEl, filtroTotalEstadoEl;
        let openUnidadeModalBtn, unidadeModal, modalOverlay, closeModalBtn, unidadeSearchInput, unidadeListContainer, clearUnidadeSelectionBtn;
        let analiseResultsContainer, analiseSummaryContainer, analiseFilterEl;
        let connectionStatusEl;
        
        // --- FUNÇÕES DE BUSCA E PROCESSAMENTO DE DADOS ---
        class DataManager {
            constructor() {
                this.cacheKey = 'dashboard_cache_v3';
                this.cacheExpiry = 5 * 60 * 1000; // 5 minutos
                this.loadingPromises = new Map();
            }

            async fetchWithCache(url, key, type = 'json') {
                const cached = this.getFromCache(key);
                if (cached && (Date.now() - cached.timestamp < this.cacheExpiry)) {
                    console.log(`Loading ${key} from cache.`);
                    return cached.data;
                }
                
                console.log(`Fetching ${key} from network.`);
                if (this.loadingPromises.has(key)) {
                    return this.loadingPromises.get(key);
                }

                const promise = this.fetchData(url, type).then(data => {
                    this.saveToCache(key, data);
                    this.loadingPromises.delete(key);
                    return data;
                }).catch(error => {
                    this.loadingPromises.delete(key);
                    throw error;
                });

                this.loadingPromises.set(key, promise);
                return promise;
            }

            async fetchData(url, type) {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                if (type === 'json') {
                    const rawData = await response.json();
                     if (rawData && rawData.error) throw new Error(`Erro do Apps Script: ${rawData.error}`);
                    return Array.isArray(rawData) ? rawData : (rawData && Array.isArray(rawData.content)) ? rawData.content : null;
                }
                return response.text();
            }

            saveToCache(key, data) {
                try {
                    const cache = this.getAllCache();
                    cache[key] = { data, timestamp: Date.now() };
                    localStorage.setItem(this.cacheKey, JSON.stringify(cache));
                } catch (e) {
                    console.warn("Could not save to cache, it might be full. Clearing cache.");
                    localStorage.removeItem(this.cacheKey);
                }
            }

            getFromCache(key) {
                const cache = this.getAllCache();
                return cache[key] || null;
            }

            getAllCache() {
                try {
                    return JSON.parse(localStorage.getItem(this.cacheKey)) || {};
                } catch {
                    return {};
                }
            }
        }
        const dataManager = new DataManager();

        /**
         * Normaliza a descrição de um item para agrupar itens similares no gráfico do dashboard.
         * @param {string} description A descrição original do item.
         * @returns {string} A descrição normalizada e agrupada.
         */
        function normalizeItemDescriptionForChart(description) {
            if (!description) return 'N/D';
            
            // 1. Remove parênteses e espaços extras para uma análise mais limpa.
            // Ex: "Cadeira (atendimento)" vira "cadeira"
            let normalized = String(description)
                .toLowerCase()
                .replace(/\(.*?\)/g, '') // Remove texto entre parênteses
                .trim();

            // 2. Regra de agrupamento específica e mais robusta para Cadeira de Plástico.
            // Procura por 'cadeira' e ('plastico' ou 'plástica') independentemente da ordem.
            if (normalized.includes('cadeira') && (normalized.includes('plastico') || normalized.includes('plástica'))) {
                return 'Cadeira de Plástico';
            }
            
            // 3. Para todos os outros itens, retorna a descrição original (mas limpa e capitalizada).
            const cleanDescription = description.replace(/\(.*?\)/g, '').trim();
            // Retorna 'N/D' se a descrição ficar vazia após a limpeza.
            if (!cleanDescription) return 'N/D';
            return cleanDescription.charAt(0).toUpperCase() + cleanDescription.slice(1);
        }


        function parseCsvData(csvText) {
            const lines = csvText.trim().split(/\r\n|\n/);
            if (lines.length < 2) return [];
            const headerLine = lines[0];
            const delimiter = headerLine.includes(';') ? ';' : ',';
            const splitRegex = new RegExp(`${delimiter}(?=(?:(?:[^"]*"){2})*[^"]*$)`);
            const headers = headerLine.split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(splitRegex);
                const item = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j] ? values[j].trim() : '';
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    item[headers[j]] = value;
                }
                data.push(item);
            }
            return data;
        }

        const capitalizeWords = (str) => {
            if (!str) return "";
            return str.toLowerCase().replace(/([^\s/]+)/g, word => word.charAt(0).toUpperCase() + word.slice(1));
        };

        function getServiceKey(serviceName) {
            const name = (serviceName || '').toLowerCase().trim();
            if (name === 'conselho' || name === 'ct') return 'conselho';
            if (name.includes('cras')) return 'cras';
            if (name.includes('creas')) return 'creas';
            if (name.includes('externa')) return 'externa';
            if (name.includes('centro pop') || name === 'centro pop') return 'centro_pop';
            if (name.includes('abrigo')) return 'abrigo';
            if (name.includes('sede')) return 'sede';
            return 'item';
        }
        
        function cleanDuplicatedString(str) {
            if (typeof str !== 'string' || str.length < 2 || str.length % 2 !== 0) {
                return str;
            }
            const half = str.length / 2;
            const firstHalf = str.substring(0, half);
            const secondHalf = str.substring(half);
            if (firstHalf.toLowerCase() === secondHalf.toLowerCase()) {
                return firstHalf;
            }
            return str;
        }

        function formatSheetData(sheetData) {
            return sheetData.map((row, index) => {
                const standardizedUnitName = capitalizeWords((row.Unidade || 'N/A').trim());
                let originalState = row.Estado || 'Regular';
                let finalState = originalState;
                const observationTextRaw = (row['Observação'] || '').toLowerCase();
                const isDamagedByObs = /avariado|defeito|danificado|não funciona|nao funciona/.test(observationTextRaw);
                const isDamagedByState = /defeito|avaria|danificado|nao funciona/.test(normalizeString(originalState));

                // A Observação tem prioridade máxima para definir como 'Avariado'
                if (isDamagedByObs) {
                    finalState = 'Avariado';
                } else if (isDamagedByState) {
                    finalState = 'Avariado';
                }
                
                const serviceKey = getServiceKey(row.Tipo);
                const rawObservation = (row['Observação'] || '').trim();
                const cleanedObservation = cleanDuplicatedString(rawObservation);
                const processedObservation = (cleanedObservation === '-' || normalizeString(cleanedObservation) === 'n/a') ? '' : cleanedObservation;
                const rawDonationSource = (row['Origem da Doação'] || '').trim();
                const processedDonationSource = (rawDonationSource === '-' || normalizeString(rawDonationSource) === 'n/a' || rawDonationSource === '') ? '' : rawDonationSource;
                const rawSupplier = (row.Fornecedor || '').trim();
                const processedSupplier = (rawSupplier === '-' || normalizeString(rawSupplier) === 'n/a') ? '' : rawSupplier;
                return {
                    id: `${serviceKey}_${index}`,
                    type: row.Tipo || 'N/A',
                    description: row['Descrição'] || 'N/A',
                    unit_condition: standardizedUnitName,
                    quantity: parseInt(row.Quantidade, 10) || 1,
                    location: row['Localização'] || 'N/A',
                    state: finalState,
                    donation_source: processedDonationSource,
                    observation: processedObservation,
                    supplier: processedSupplier,
                    originalStateWasNew: originalState === 'Novo'
                };
            });
        }

        function normalizeString(str) {
            if (!str) return '';
            return String(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        const stateColors = {
            'Novo': { bg: 'badge-green', text: 'text-green-800', hex: '#16a34a' },
            'Bom': { bg: 'badge-blue', text: 'text-blue-800', hex: '#2563eb' },
            'Regular': { bg: 'badge-yellow', text: 'text-yellow-800', hex: '#facc15' },
            'Avariado': { bg: 'badge-red', text: 'text-red-800', hex: '#dc2626' }
        };

        function agruparItens(items) {
            if (!items || items.length === 0) return [];
            const agrupados = items.reduce((acc, item) => {
                const isDefective = item.state === 'Avariado';
                const key = isDefective 
                    ? `${normalizeString(item.type)}-${normalizeString(item.description)}-${item.state}-${normalizeString(item.unit_condition)}-${normalizeString(item.location)}-${normalizeString(item.observation) || 'no-obs'}-${normalizeString(item.supplier) || 'no-sup'}`
                    : `${normalizeString(item.type)}-${normalizeString(item.description)}-${item.state}-${normalizeString(item.unit_condition)}-${normalizeString(item.location)}`;
                if (acc[key]) {
                    acc[key].quantity += parseInt(item.quantity, 10);
                } else {
                    acc[key] = {...item, quantity: parseInt(item.quantity, 10) };
                }
                return acc;
            }, {});
            return Object.values(agrupados);
        }

        function formatUnitName(item) {
            let nomeUnidade = item.unit_condition;
            const type = item.type.toUpperCase();
            const lowerCaseName = nomeUnidade.toLowerCase();
            
            if (type === 'CRAS' && !lowerCaseName.startsWith('cras')) {
                return `CRAS ${nomeUnidade}`;
            }
            if (type === 'CREAS' && !lowerCaseName.startsWith('creas')) {
                return `CREAS ${nomeUnidade}`;
            }
            if (type === 'CT') {
                 return `CT ${nomeUnidade}`;
            }
            
            const regex = new RegExp(`^${type}\\s*`, 'i');
            return nomeUnidade.replace(regex, `${type} `).trim().toUpperCase();
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function GerarRelatorioUnidade(dados) {
            if (!dados || dados.length === 0) return "Nenhum dado disponível para gerar o relatório.";
            const stateCounts = dados.reduce((acc, item) => {
                acc[item.state] = (acc[item.state] || 0) + parseInt(item.quantity, 10);
                return acc;
            }, {Novo: 0, Bom: 0, Regular: 0, Avariado: 0});
            const totalUnitItems = Object.values(stateCounts).reduce((sum, count) => sum + count, 0);
            let reportLines = [];
            reportLines.push(`A unidade possui um total de <strong>${totalUnitItems}</strong> itens (considerando o filtro atual).`);
            reportLines.push(`A situação geral é: <strong>${stateCounts.Novo || 0}</strong> novos, <strong>${stateCounts.Bom || 0}</strong> bons, <strong>${stateCounts.Regular || 0}</strong> regulares e <strong>${stateCounts.Avariado || 0}</strong> avariados.`);
            const avariadosDetalhes = dados.filter(item => item.state === 'Avariado');
            if (avariadosDetalhes.length > 0) {
                const totalAvariados = avariadosDetalhes.reduce((sum, item) => sum + item.quantity, 0);
                reportLines.push(`<br><strong>Ponto de Atenção:</strong> Total de ${totalAvariados} itens que precisam de atenção:`);
                const listaAvariados = agruparItens(avariadosDetalhes).map(item => `<li>${item.quantity}x ${item.description} (Local: ${item.location})</li>`).join('');
                reportLines.push(`<ul class="list-disc list-inside">${listaAvariados}</ul>`);
            } else {
                reportLines.push(`<br><strong>Ponto de Atenção:</strong> Nenhum item avariado foi registrado (considerando o filtro atual).`);
            }
            return reportLines.join('<br>');
        }

        function renderTable(itemsToDisplay, totalItemsCount, enablePagination = true) {
            if (!tableBodyEl) return;
            if (itemsToDisplay.length === 0) {
                tableBodyEl.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-slate-500">Nenhum item encontrado com os filtros aplicados.</td></tr>`;
                renderPagination(0, 0, enablePagination);
                return;
            }
            let tableHTML = '';
            itemsToDisplay.forEach(item => {
                const isNewButDefective = item.originalStateWasNew && item.state === 'Avariado';
                const colorInfo = stateColors[item.state] || stateColors['Regular'];
                const unitDisplayName = formatUnitName(item);
                const stateTextClass = isNewButDefective ? 'text-red-600 font-semibold' : colorInfo.text;
                const stateDisplayName = isNewButDefective ? `Novo (Avariado)` : item.state;
                const observationText = item.observation || '';
                const supplierText = item.supplier || '';
                const finalSupplierText = (observationText && supplierText && normalizeString(observationText) === normalizeString(supplierText)) ? 'N/A' : (supplierText || 'N/A');
                tableHTML += `
                    <tr class="border-b border-slate-200">
                        <td class="px-6 py-4">${item.type}</td>
                        <td class="px-6 py-4 font-medium text-slate-900">${item.description}</td>
                        <td class="px-6 py-4">${unitDisplayName}</td>
                        <td class="px-6 py-4 text-center">${item.quantity}</td>
                        <td class="px-6 py-4">${item.location}</td>
                        <td class="px-6 py-4"><span class="badge ${colorInfo.bg} ${stateTextClass}">${stateDisplayName}</span></td>
                        <td class="px-6 py-4">${item.donation_source || 'N/A'}</td>
                        <td class="px-6 py-4">${observationText ? `<div class="tooltip">${String(observationText).substring(0, 30)}${String(observationText).length > 30 ? '...' : ''}<span class="tooltip-text">${observationText}</span></div>` : 'N/A'}</td>
                        <td class="px-6 py-4">${finalSupplierText}</td>
                    </tr>`;
            });
            tableBodyEl.innerHTML = tableHTML;
            renderPagination(totalItemsCount, Math.ceil(totalItemsCount / itemsPerPage), enablePagination);
        }

        function renderPagination(totalItems, totalPages, enablePagination) {
            if (!paginationControlsEl) return;
            paginationControlsEl.innerHTML = '';
            if (!enablePagination || totalPages <= 1) return;
            paginationControlsEl.innerHTML = `
                <span class="text-sm text-slate-600">Mostrando ${Math.min((currentPage - 1) * itemsPerPage + 1, totalItems)} a ${Math.min(currentPage * itemsPerPage, totalItems)} de ${totalItems} itens</span>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                    <button type="button" data-page="${currentPage - 1}" class="px-4 py-2 text-sm font-medium border border-slate-300 rounded-l-lg hover:bg-slate-100 disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>
                    <button type="button" data-page="${currentPage + 1}" class="px-4 py-2 text-sm font-medium border border-slate-300 rounded-r-lg hover:bg-slate-100 disabled:opacity-50" ${currentPage === totalPages ? 'disabled' : ''}>Próximo</button>
                </div>`;
        }

        function getFilteredItems(sourceData) {
            const servico = filtroServicoEl.value;
            const unidade = selectedUnidadeValue;
            const estado = filtroEstadoEl.value;
            const doacao = filtroDoacaoEl.value;
            const busca = filtroBuscaEl.value.toLowerCase();
            if (!servico && !unidade && !estado && !busca && !doacao) return sourceData;
            return sourceData.filter(item => {
                const matchServico = !servico || item.id.startsWith(`${servico}_`);
                const matchUnidade = !unidade || item.unit_condition === unidade;
                const matchEstado = !estado || item.state === estado;
                const source = normalizeString(item.donation_source);
                const matchDoacao = !doacao || (doacao === 'sim' && item.donation_source && !['proprio', 'proprios'].includes(source)) || (doacao === 'nao' && (!item.donation_source || ['proprio', 'proprios'].includes(source)));
                const matchBusca = !busca || item.description.toLowerCase().includes(busca) || item.type.toLowerCase().includes(busca) || item.location.toLowerCase().includes(busca) || (item.observation && item.observation.toLowerCase().includes(busca));
                return matchServico && matchUnidade && matchEstado && matchDoacao && matchBusca;
            });
        }

        function updateFilterOptions() {
            if (!allItems || allItems.length === 0) return;
            const allStates = [...new Set(allItems.map(item => item.state))];
            const sortedStates = ['Novo', 'Bom', 'Regular', 'Avariado'].filter(s => allStates.includes(s));
            filtroEstadoEl.innerHTML = '<option value="">TODOS</option>';
            sortedStates.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s.toUpperCase();
                filtroEstadoEl.appendChild(option);
            });
        }

        function generateRanking(data, states) {
            const counts = data.filter(item => states.includes(item.state)).reduce((acc, item) => {
                const unitName = formatUnitName(item);
                acc[unitName] = (acc[unitName] || 0) + item.quantity;
                return acc;
            }, {});
            return Object.entries(counts).map(([nome, quantidade]) => ({ nome, quantidade })).sort((a, b) => b.quantidade - a.quantidade).slice(0, 5);
        }

        function renderRanking(data, title, colorClass, rankingListEl) {
            const rankingCardTitle = rankingListEl.previousElementSibling;
            if (!rankingListEl || !rankingCardTitle) return;
            rankingCardTitle.textContent = title;
            if (data.length === 0) {
                rankingListEl.innerHTML = `<li class="text-center text-slate-500 py-4">Nenhum item encontrado.</li>`;
            } else {
                rankingListEl.innerHTML = data.map((unidade, index) => `
                    <li class="flex justify-between items-center p-3 rounded-lg ${index === 0 ? 'bg-slate-200' : 'bg-slate-100'}">
                        <span class="font-medium text-slate-700">${index + 1}. ${unidade.nome}</span>
                        <span class="font-bold ${colorClass}">${unidade.quantidade} itens</span>
                    </li>`).join('');
            }
        }

        function renderApp() {
            if (estadoChartInstance) { estadoChartInstance.destroy(); estadoChartInstance = null; }
            const currentFilteredData = getFilteredItems(dadosOriginais);
            const filteredAndGroupedItems = agruparItens(currentFilteredData);
            const tableHeadersHTML = `<thead class="text-xs uppercase"><tr><th scope="col" class="px-6 py-3">Tipo</th><th scope="col" class="px-6 py-3">Descrição</th><th scope="col" class="px-6 py-3">Unidade</th><th scope="col" class="px-6 py-3 text-center">Qtd</th><th scope="col" class="px-6 py-3">Localização</th><th scope="col" class="px-6 py-3">Estado</th><th scope="col" class="px-6 py-3">Origem da Doação</th><th scope="col" class="px-6 py-3">Observação</th><th scope="col" class="px-6 py-3">Fornecedor</th></tr></thead>`;
            
            if (visaoAtiva === 'boasVindas') {
                mainContentAreaEl.innerHTML = `<div class="text-center p-10 sm:p-20 card"><p class="text-xl text-slate-600">Selecione um <strong>Tipo de Unidade</strong> para ver os detalhes, ou clique em <strong>Ver Inventário Completo</strong> para uma visão geral.</p></div>`;
            } else if (visaoAtiva === 'unidade') {
                const totalDoacoes = currentFilteredData.filter(item => { const source = normalizeString(item.donation_source); return item.donation_source && !['proprio', 'proprios'].includes(source); }).reduce((sum, item) => sum + parseInt(item.quantity, 10), 0);
                const descriptiveReportContent = GerarRelatorioUnidade(currentFilteredData);
                mainContentAreaEl.innerHTML = `<div><h2 class="text-3xl font-bold text-slate-800 mb-6">${tituloDaVisao}</h2><div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-2 flex flex-col gap-6"><div class="card h-full"><div class="chart-container"><canvas id="estadoChart"></canvas></div></div><div class="card text-center"><h3 class="text-lg font-semibold text-purple-800">Itens de Doação</h3><p class="text-3xl font-bold text-purple-700 mt-2">${totalDoacoes}</p></div></div><div class="lg:col-span-3 card"><h3 class="text-xl font-bold text-slate-700 mb-4">Relatório Descritivo da Unidade</h3><div class="text-slate-600 space-y-2">${descriptiveReportContent}</div></div></div><h2 class="text-2xl font-bold text-slate-800 mb-6 mt-8">Inventário Detalhado da Unidade</h2><div class="card p-0 overflow-x-auto"><table class="table w-full text-sm text-left">${tableHeadersHTML}<tbody id="inventory-table-body"></tbody></table></div><div id="pagination-controls" class="flex items-center justify-between mt-6"></div></div>`;
                updateDynamicDOMReferences();
                renderTable(filteredAndGroupedItems.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage), filteredAndGroupedItems.length, true);
                const chartCanvas = document.getElementById('estadoChart');
                if (chartCanvas) {
                    const chartData = {
                         type: 'bar',
                         data: { 
                            labels: ['Novo', 'Bom', 'Regular', 'Avariado'], 
                            datasets: [{ 
                                label: 'Quantidade', 
                                data: ['Novo', 'Bom', 'Regular', 'Avariado'].map(state => currentFilteredData.filter(i => i.state === state).reduce((sum, i) => sum + i.quantity, 0)), 
                                backgroundColor: ['#16a34a', '#2563eb', '#facc15', '#dc2626'] 
                            }] 
                         },
                         options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { text: 'Distribuição por Estado', display: true, font: { size: 16 }, color: '#334155' },
                                legend: { display: false }
                            }
                         }
                    };
                    if (estadoChartInstance) estadoChartInstance.destroy();
                    estadoChartInstance = new Chart(chartCanvas, chartData);
                }
            } else if (visaoAtiva === 'resumo') {
                mainContentAreaEl.innerHTML = `<div><div class="flex justify-between items-start flex-wrap gap-4"><h2 class="text-3xl font-bold text-slate-800">${tituloDaVisao}</h2></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6"><div class="card"><div class="chart-container"><canvas id="estadoChart"></canvas></div></div><div class="card"><h3 class="text-xl font-bold text-slate-700 mb-4"></h3><ul class="space-y-3"></ul></div></div><h2 class="text-2xl font-bold text-slate-800 mb-6 mt-8">Inventário Detalhado (Resumo Geral)</h2><div class="card p-0 overflow-x-auto"><table class="table w-full text-sm text-left">${tableHeadersHTML}<tbody id="inventory-table-body"></tbody></table></div><div id="pagination-controls" class="flex items-center justify-between mt-6"></div></div>`;
                updateDynamicDOMReferences();
                const filteredAllItems = getFilteredItems(allItems);
                const groupedAllItems = agruparItens(filteredAllItems);
                renderTable(groupedAllItems.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage), groupedAllItems.length, true);
                const chartCanvas = document.getElementById('estadoChart');
                if (chartCanvas) {
                    const chartData = {
                         type: 'bar',
                         data: { 
                            labels: ['Novo', 'Bom', 'Regular', 'Avariado'], 
                            datasets: [{ 
                                label: 'Quantidade', 
                                data: ['Novo', 'Bom', 'Regular', 'Avariado'].map(state => filteredAllItems.filter(i => i.state === state).reduce((sum, i) => sum + i.quantity, 0)), 
                                backgroundColor: ['#16a34a', '#2563eb', '#facc15', '#dc2626'] 
                            }] 
                         },
                         options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: { text: 'Distribuição por Estado', display: true, font: { size: 16 }, color: '#334155' },
                                legend: { display: false }
                            }
                         }
                    };
                    if (estadoChartInstance) estadoChartInstance.destroy();
                    estadoChartInstance = new Chart(chartCanvas, chartData);
                }
                const rankingListEl = mainContentAreaEl.querySelector('ul');
                if (filtroEstadoEl.value === 'Novo') {
                    const rankingData = generateRanking(filteredAllItems, ['Novo']);
                    renderRanking(rankingData, 'Top 5 - Unidades com itens novos', 'text-green-600', rankingListEl);
                } else {
                    const rankingData = generateRanking(filteredAllItems, ['Regular', 'Avariado']);
                    renderRanking(rankingData, 'Top 5 - Unidades para atenção', 'text-red-600', rankingListEl);
                }
            }
        }

        function renderEstoque(items) {
            mainContentEstoqueEl.innerHTML = '';
            if (items.length === 0) {
                mainContentEstoqueEl.innerHTML = `<div class="card text-center p-10"><p class="text-xl text-slate-600">Nenhum item de estoque encontrado.</p></div>`;
                return;
            }
            const unidadesEstoque = [...new Set(items.map(item => item.Unidade || 'N/A'))].sort();
            filtroEstoqueUnidadeEl.innerHTML = '<option value="">TODAS AS UNIDADES</option>';
            unidadesEstoque.forEach(u => {
                const option = document.createElement('option');
                option.value = u; option.textContent = u.toUpperCase();
                filtroEstoqueUnidadeEl.appendChild(option);
            });
            const busca = filtroEstoqueBuscaEl.value.toLowerCase();
            const unidade = filtroEstoqueUnidadeEl.value;
            const filteredItems = items.filter(item => {
                const matchUnidade = !unidade || item.Unidade === unidade;
                const matchBusca = !busca || (item.Item || '').toLowerCase().includes(busca) || (item.Fornecedor || '').toLowerCase().includes(busca);
                return matchUnidade && matchBusca;
            });
            const headers = Object.keys(filteredItems[0] || {});
            const tableHTML = `<div class="card p-0 overflow-x-auto"><table class="table w-full text-sm text-left"><thead class="text-xs uppercase"><tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h.toUpperCase()}</th>`).join('')}</tr></thead><tbody>${filteredItems.map(item => `<tr class="border-b border-slate-200">${headers.map(h => `<td class="px-6 py-4">${item[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            mainContentEstoqueEl.innerHTML = tableHTML;
            const estoqueData = filteredItems.reduce((acc, item) => {
                const desc = item.Item || 'N/D';
                const qty = parseInt(item.Quantidade, 10) || 0;
                acc[desc] = (acc[desc] || 0) + qty;
                return acc;
            }, {});
            const top10 = Object.entries(estoqueData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const chartCanvas = document.getElementById('estoqueBarChart');
            if (chartCanvas) {
                const chartData = {
                    type: 'bar',
                    data: { 
                        labels: top10.map(item => item[0]), 
                        datasets: [{ 
                            label: 'Quantidade', 
                            data: top10.map(item => item[1]), 
                            backgroundColor: '#36a2eb' 
                        }] 
                    },
                    options: { 
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            title: { text: 'TOP 10 ITENS EM ESTOQUE', display: true },
                            legend: { display: false }
                        } 
                    }
                };
                if (estoqueChartInstance) estoqueChartInstance.destroy();
                estoqueChartInstance = new Chart(chartCanvas, chartData);
            }
        }

        function populateTotalItensUnidades() {
            const selectedCategoria = filtroTotalCategoriaEl.value;
            let itemsToConsider = allItems;

            // If a category is selected, filter the items
            if (selectedCategoria) {
                itemsToConsider = allItems.filter(item => item.type === selectedCategoria);
            }

            const unidades = [...new Set(itemsToConsider.map(item => formatUnitName(item)))].sort((a, b) => a.localeCompare(b));
            
            const currentUnidadeValue = filtroTotalUnidadeEl.value;
            filtroTotalUnidadeEl.innerHTML = '<option value="">TODAS</option>';
            
            unidades.forEach(u => {
                const option = document.createElement('option');
                option.value = u;
                option.textContent = u.toUpperCase();
                filtroTotalUnidadeEl.appendChild(option);
            });

            // Check if the previously selected value is still in the new list of options
            if (unidades.includes(currentUnidadeValue)) {
                filtroTotalUnidadeEl.value = currentUnidadeValue;
            }
        }


        function populateTotalItensFilters() {
            if (!filtroTotalCategoriaEl || !filtroTotalUnidadeEl || !filtroTotalEstadoEl || !allItems || allItems.length === 0) return;
            
            // Populate Categories
            const categorias = [...new Set(allItems.map(item => item.type))].filter(type => type && type !== 'N/A').sort((a, b) => a.localeCompare(b));
            const currentCategoria = filtroTotalCategoriaEl.value;
            filtroTotalCategoriaEl.innerHTML = '<option value="">TODAS</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat.toUpperCase();
                filtroTotalCategoriaEl.appendChild(option);
            });
            if (currentCategoria) filtroTotalCategoriaEl.value = currentCategoria;

            // Populate Units based on selected category
            populateTotalItensUnidades();

            // Populate States
            const allStates = [...new Set(allItems.map(item => item.state))];
            const sortedStates = ['Novo', 'Bom', 'Regular', 'Avariado'].filter(s => allStates.includes(s));
            const currentState = filtroTotalEstadoEl.value;
            filtroTotalEstadoEl.innerHTML = '<option value="">TODOS</option>';
            sortedStates.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s.toUpperCase();
                filtroTotalEstadoEl.appendChild(option);
            });
            if (currentState) filtroTotalEstadoEl.value = currentState;
        }

        function renderTotalItens() {
            const listContainer = document.getElementById('total-itens-list');
            const detailsContainer = document.getElementById('total-itens-details-container');
            const listCountEl = document.getElementById('total-itens-list-count');
            if (!listContainer || !detailsContainer) return;

            const selectedCategoria = filtroTotalCategoriaEl.value;
            const searchTerm = filtroTotalItemEl.value.toLowerCase();
            const selectedUnidade = filtroTotalUnidadeEl.value;
            const selectedEstado = filtroTotalEstadoEl.value;

            let filteredData = allItems;
            if (selectedCategoria) filteredData = filteredData.filter(item => item.type === selectedCategoria);
            if (selectedUnidade) filteredData = filteredData.filter(item => formatUnitName(item) === selectedUnidade);
            if (selectedEstado) filteredData = filteredData.filter(item => item.state === selectedEstado);
            if (searchTerm) filteredData = filteredData.filter(item => item.description.toLowerCase().includes(searchTerm));

            const groupedItems = {};
            filteredData.forEach(item => {
                const desc = item.description;
                if (!desc || desc === 'N/A') return;
                if (!groupedItems[desc]) {
                    groupedItems[desc] = { total: 0, type: item.type, items: [] };
                }
                groupedItems[desc].total += item.quantity;
                groupedItems[desc].items.push(item);
            });

            const sortedItemNames = Object.keys(groupedItems).sort((a, b) => a.localeCompare(b));
            listCountEl.textContent = `${sortedItemNames.length} itens encontrados`;

            if (sortedItemNames.length === 0) {
                listContainer.innerHTML = `<div class="p-4 text-center text-slate-500">Nenhum item encontrado.</div>`;
                detailsContainer.innerHTML = '';
                return;
            }

            listContainer.innerHTML = sortedItemNames.map(desc => `
                <div class="total-item-entry" data-item-name="${desc}">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-slate-800 truncate pr-2">${desc}</span>
                        <span class="text-sm font-bold bg-slate-200 text-slate-700 rounded-full px-2 py-0.5">${groupedItems[desc].total}</span>
                    </div>
                    <div class="text-xs text-slate-500">${groupedItems[desc].type}</div>
                </div>
            `).join('');
            
            // Adiciona event listeners para a nova lista
            document.querySelectorAll('.total-item-entry').forEach(el => {
                el.addEventListener('click', (e) => {
                    const selectedItem = e.currentTarget;
                    const itemName = selectedItem.dataset.itemName;
                    
                    // Remove a seleção anterior
                    document.querySelectorAll('.total-item-entry.selected').forEach(prev => prev.classList.remove('selected'));
                    // Adiciona a seleção atual
                    selectedItem.classList.add('selected');

                    renderTotalItemDetails(itemName, groupedItems[itemName]);
                });
            });

            // Renderiza o detalhe do primeiro item da lista por padrão
            if (sortedItemNames.length > 0) {
                const firstItemName = sortedItemNames[0];
                listContainer.querySelector('.total-item-entry').classList.add('selected');
                renderTotalItemDetails(firstItemName, groupedItems[firstItemName]);
            } else {
                 detailsContainer.innerHTML = `<div class="card text-center p-10"><p class="text-lg text-slate-600">Selecione um item da lista para ver os detalhes.</p></div>`;
            }
        }

        function renderTotalItemDetails(itemName, data) {
            const detailsContainer = document.getElementById('total-itens-details-container');
            if (!data) {
                detailsContainer.innerHTML = '';
                return;
            }

            const stateCounts = data.items.reduce((acc, item) => {
                acc[item.state] = (acc[item.state] || 0) + item.quantity;
                return acc;
            }, {});

            const distribution = {};
            data.items.forEach(item => {
                const unitName = formatUnitName(item);
                const location = item.location || 'N/D';
                const key = `${unitName} >> ${location}`;
                if (!distribution[key]) {
                    distribution[key] = { quantity: 0, state: item.state };
                }
                distribution[key].quantity += item.quantity;
            });

            const statesHTML = Object.entries(stateColors).map(([state, colorInfo]) => {
                const count = stateCounts[state] || 0;
                if (count === 0) return '';
                return `<div class="flex items-center gap-2">
                            <span class="h-2 w-2 rounded-full" style="background-color: ${colorInfo.hex}"></span>
                            <span>${state}:</span>
                            <span class="font-bold">${count}</span>
                        </div>`;
            }).join('');

            const distributionHTML = Object.entries(distribution).sort((a, b) => a[0].localeCompare(b[0])).map(([key, value]) => `
                <tr class="border-b border-slate-200">
                    <td class="px-4 py-2">${key.replace(' >> ', '<span class="text-slate-400 mx-2">›</span>')}</td>
                    <td class="px-4 py-2 text-center font-bold">${value.quantity}</td>
                    <td class="px-4 py-2 text-center"><span class="badge ${stateColors[value.state]?.bg}">${value.state}</span></td>
                </tr>
            `).join('');

            detailsContainer.innerHTML = `
                <div class="card fade-in">
                    <h2 class="text-2xl font-bold text-slate-800">${itemName}</h2>
                    <p class="text-sm text-slate-500 mb-4">Total de ${data.total} unidades</p>
                    
                    <div class="card bg-slate-50 mb-6">
                        <h4 class="font-semibold text-slate-700 mb-2">Resumo por Estado</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            ${statesHTML}
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-slate-700 mb-2">Distribuição por Local</h4>
                        <div class="max-h-96 overflow-y-auto border border-slate-200 rounded-lg">
                            <table class="table w-full text-sm">
                                <thead class="sticky top-0 bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-2">Unidade / Localização</th>
                                        <th class="px-4 py-2 text-center">Qtd.</th>
                                        <th class="px-4 py-2 text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${distributionHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- LÓGICA DA MODAL ---
        function openUnidadeModal() {
            unidadeModal.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                unidadeModal.querySelector('.modal-container').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeUnidadeModal() {
            unidadeModal.querySelector('.modal-container').classList.add('scale-95', 'opacity-0');
            modalOverlay.classList.add('opacity-0');
            setTimeout(() => {
                unidadeModal.classList.add('hidden');
            }, 300);
        }

        function populateUnidadeModalList(searchTerm = "") {
            const selectedServico = filtroServicoEl.value;
            let unidades = [];
            if (selectedServico) {
                const unidadesDoServico = [...new Set(allItems.filter(item => item.id.startsWith(`${selectedServico}_`)).map(item => item.unit_condition))];
                unidades = unidadesDoServico.map(u => {
                    const itemExemplo = allItems.find(item => item.unit_condition === u && item.id.startsWith(`${selectedServico}_`));
                    return {
                        value: u,
                        text: itemExemplo ? formatUnitName(itemExemplo) : u.toUpperCase()
                    };
                }).sort((a, b) => a.text.localeCompare(b.text));
            }

            const filteredUnidades = unidades.filter(u => normalizeString(u.text).includes(normalizeString(searchTerm)));

            if (filteredUnidades.length > 0) {
                unidadeListContainer.innerHTML = filteredUnidades.map(u =>
                    `<li data-value="${u.value}" data-text="${u.text}" class="p-3 rounded-md hover:bg-slate-100 cursor-pointer break-words">${u.text}</li>`
                ).join('');
            } else {
                unidadeListContainer.innerHTML = `<li class="p-3 text-center text-slate-500">Nenhuma unidade encontrada.</li>`;
            }
        }

        // --- LÓGICA DA ANÁLISE DE NECESSIDADES ---
        function runNeedsAnalysis() {
            const suitableLocations = ['recepção', 'sala', 'atendimento', 'cozinha', 'refeitório', 'copa', 'auditório', 'gabinete'];
            
            const itemsForAnalysis = allItems.filter(item => normalizeString(item.type) !== 'sede');
            const units = [...new Set(itemsForAnalysis.map(item => formatUnitName(item)))];
            
            analysisResults = [];

            units.forEach(unitName => {
                const unitItems = itemsForAnalysis.filter(item => formatUnitName(item) === unitName);
                const unitNeeds = {
                    unitName: unitName,
                    missing: []
                };

                const hasBebedouro = unitItems.some(item => normalizeString(item.description).includes('bebedouro'));
                if (!hasBebedouro) {
                    unitNeeds.missing.push({ item: 'Bebedouro', location: 'Área Comum (Ex: Recepção ou Copa)' });
                }

                const locationsInUnit = [...new Set(unitItems.map(item => item.location))];
                const relevantLocations = locationsInUnit.filter(loc => suitableLocations.some(sLoc => normalizeString(loc).includes(sLoc)));
                
                relevantLocations.forEach(location => {
                    const itemsInLocation = unitItems.filter(item => item.location === location);
                    const hasAC = itemsInLocation.some(item => normalizeString(item.description).includes('ar condicionado'));
                    const hasVentilador = itemsInLocation.some(item => normalizeString(item.description).includes('ventilador'));

                    if (!hasAC && !hasVentilador) {
                        unitNeeds.missing.push({ item: 'Ar Condicionado ou Ventilador', location: location });
                    }
                });

                if (unitNeeds.missing.length > 0) {
                    analysisResults.push(unitNeeds);
                }
            });
        }

        function getFilteredAnalysisResults() {
            const filterValue = analiseFilterEl.value;
            if (filterValue === 'todos') {
                return analysisResults;
            }
            if (filterValue === 'bebedouro') {
                return analysisResults
                    .map(unit => ({
                        ...unit,
                        missing: unit.missing.filter(need => need.item === 'Bebedouro')
                    }))
                    .filter(unit => unit.missing.length > 0);
            }
            if (filterValue === 'climatizacao') {
                return analysisResults
                    .map(unit => ({
                        ...unit,
                        missing: unit.missing.filter(need => need.item === 'Ar Condicionado ou Ventilador')
                    }))
                    .filter(unit => unit.missing.length > 0);
            }
            return [];
        }

        function renderNeedsAnalysisReport() {
            analiseResultsContainer.innerHTML = '';
            analiseSummaryContainer = document.getElementById('analise-summary');
            
            const filteredResults = getFilteredAnalysisResults();

            if (filteredResults.length === 0) {
                analiseSummaryContainer.innerHTML = '';
                analiseResultsContainer.innerHTML = `<div class="col-span-full card text-center p-10"><p class="text-xl text-green-600 font-semibold">Tudo em ordem!</p><p class="text-slate-600 mt-2">Nenhuma necessidade encontrada para o filtro selecionado.</p></div>`;
                return;
            }
            
            analiseSummaryContainer.innerHTML = `
                <div class="card">
                    <p class="text-slate-600 font-medium">
                        Foram encontradas <span class="font-bold text-indigo-600">${filteredResults.length}</span> unidade(s) com necessidades para o filtro selecionado.
                    </p>
                </div>`;

            filteredResults.forEach(result => {
                const needsList = result.missing.map(need => 
                    `<li class="flex items-start space-x-3">
                        <svg class="h-5 w-5 text-yellow-500 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.23 2.85-1.23 3.486 0l5.58 10.822c.636 1.23.056 2.829-1.342 2.829H4.013C2.615 16.75.035 15.151.67 13.921L6.257 3.099zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        <div>
                            <p class="font-semibold text-slate-700">${need.item}</p>
                            <p class="text-sm text-slate-500">Sugestão de Local: ${need.location}</p>
                        </div>
                    </li>`
                ).join('');

                const cardHTML = `
                    <div class="card flex flex-col">
                        <h3 class="font-bold text-lg text-indigo-600 border-b border-slate-200 pb-2 mb-3">${result.unitName}</h3>
                        <ul class="space-y-3">${needsList}</ul>
                    </div>
                `;
                analiseResultsContainer.innerHTML += cardHTML;
            });
        }

        // --- HANDLERS DE EVENTOS ---
        function handleFilterChange() {
            currentPage = 1;
            renderApp();
        }

        function handleServicoChange() {
            const selectedService = this.value;
            selectedUnidadeValue = '';
            openUnidadeModalBtn.textContent = 'Selecione uma Unidade...';
            openUnidadeModalBtn.disabled = !selectedService;

            if (!selectedService) {
                visaoAtiva = 'boasVindas';
                dadosOriginais = [];
                renderApp();
            } else {
                 mainContentAreaEl.innerHTML = `<div class="card text-center p-10 sm:p-20"><p class="text-xl text-slate-600">Agora, por favor, <strong>selecione uma Unidade</strong> para ver os detalhes.</p></div>`;
            }
        }
        
        function handleUnidadeChange() {
            const servicoSelecionado = filtroServicoEl.value;
            currentPage = 1;
            if (!servicoSelecionado) return;

            if (selectedUnidadeValue) {
                dadosOriginais = allItems.filter(item => item.id.startsWith(`${servicoSelecionado}_`) && item.unit_condition === selectedUnidadeValue);
                tituloDaVisao = `Inventário de ${openUnidadeModalBtn.textContent}`;
            } else {
                dadosOriginais = allItems.filter(item => item.id.startsWith(`${servicoSelecionado}_`));
                tituloDaVisao = `Inventário de Todas as Unidades (${filtroServicoEl.options[filtroServicoEl.selectedIndex].text})`;
            }
            visaoAtiva = 'unidade';
            renderApp();
        }

        function handleResumoClick() {
            mainContentAreaEl.innerHTML = `<div class="text-center p-20"><div class="loading-spinner"></div><p class="mt-4 text-xl text-slate-600">A carregar inventário completo...</p></div>`;
            setTimeout(() => {
                dadosOriginais = allItems;
                tituloDaVisao = 'Inventário Geral Completo';
                visaoAtiva = 'resumo';
                currentPage = 1;
                filtroServicoEl.value = "";
                handleServicoChange.call(filtroServicoEl);
                renderApp();
            }, 50);
        }

        function handlePageChange(event) {
            const page = parseInt(event.target.dataset.page);
            if (page) {
                currentPage = page;
                renderApp();
            }
        }
        
        // --- CONTROLE DE ABAS E INICIALIZAÇÃO ---
        async function switchTab(tabName) {
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-tab="${tabName}"]`).classList.add('active');
            
            contentPanes.forEach(pane => pane.classList.add('hidden'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            visaoAtiva = tabName;

            if (tabName === 'dashboard') {
                if (allItems.length > 0) renderDashboard();
            } else if (tabName === 'patrimonio') {
                visaoAtiva = 'boasVindas';
                renderApp();
            } else if (tabName === 'estoque') {
                if (allEstoqueItems.length === 0) {
                    mainContentEstoqueEl.innerHTML = `<div class="card text-center p-20"><div class="loading-spinner"></div><p class="mt-4 text-xl">A carregar dados do estoque...</p></div>`;
                    try {
                        const csvText = await dataManager.fetchWithCache(googleSheetEstoqueUrl, 'estoque', 'text');
                        allEstoqueItems = parseCsvData(csvText);
                        renderEstoque(allEstoqueItems);
                    } catch (error) {
                        console.error('Erro ao carregar dados do estoque:', error);
                        mainContentEstoqueEl.innerHTML = `<div class="card text-center p-20"><p class="text-xl text-red-600"><strong>Erro:</strong> Não foi possível carregar o estoque.</p><p class="text-sm mt-2">${error.message}</p></div>`;
                    }
                } else {
                    renderEstoque(allEstoqueItems);
                }
            } else if (tabName === 'total-itens') {
                populateTotalItensFilters();
                renderTotalItens();
            } else if (tabName === 'analise') {
                analiseFilterEl.value = 'todos';
                runNeedsAnalysis();
                renderNeedsAnalysisReport();
            } else if (tabName === 'sede') {
                renderSedeReport();
            }
        }

        function updateDynamicDOMReferences() {
            tableBodyEl = document.getElementById('inventory-table-body');
            paginationControlsEl = document.getElementById('pagination-controls');
        }
        
        function initApp() {
            // Referências de elementos
            filtroServicoEl = document.getElementById('filtro-servico');
            filtroEstadoEl = document.getElementById('filtro-estado');
            filtroBuscaEl = document.getElementById('filtro-busca');
            filtroDoacaoEl = document.getElementById('filtro-doacao');
            mainContentAreaEl = document.getElementById('main-content-area');
            verResumoGeralBtn = document.getElementById('ver-resumo-geral-btn');
            navButtons = document.querySelectorAll('.nav-btn');
            contentPanes = document.querySelectorAll('main > div[id^="content-"]');
            mainContentEstoqueEl = document.getElementById('main-content-estoque');
            filtroEstoqueUnidadeEl = document.getElementById('filtro-estoque-unidade');
            filtroEstoqueBuscaEl = document.getElementById('filtro-estoque-busca');
            filtroTotalCategoriaEl = document.getElementById('filtro-total-categoria');
            filtroTotalItemEl = document.getElementById('filtro-total-item');
            filtroTotalUnidadeEl = document.getElementById('filtro-total-unidade');
            filtroTotalEstadoEl = document.getElementById('filtro-total-estado');
            openUnidadeModalBtn = document.getElementById('open-unidade-modal-btn');
            unidadeModal = document.getElementById('unidade-modal');
            modalOverlay = document.getElementById('modal-overlay');
            closeModalBtn = document.getElementById('close-modal-btn');
            unidadeSearchInput = document.getElementById('unidade-search-input');
            unidadeListContainer = document.getElementById('unidade-list-container');
            clearUnidadeSelectionBtn = document.getElementById('clear-unidade-selection-btn');
            analiseResultsContainer = document.getElementById('analise-results');
            analiseFilterEl = document.getElementById('analise-filter');
            connectionStatusEl = document.getElementById('connectionStatus');
            
            openUnidadeModalBtn.disabled = true;

            // Event Listeners
            filtroServicoEl.addEventListener('change', handleServicoChange);
            filtroEstadoEl.addEventListener('change', handleFilterChange);
            filtroDoacaoEl.addEventListener('change', handleFilterChange);
            filtroBuscaEl.addEventListener('input', debounce(handleFilterChange, 400));
            verResumoGeralBtn.addEventListener('click', handleResumoClick);
            document.addEventListener('click', (event) => { if (event.target && event.target.dataset.page) { handlePageChange(event); } });
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });

            filtroEstoqueUnidadeEl.addEventListener('input', () => renderEstoque(allEstoqueItems));
            filtroEstoqueBuscaEl.addEventListener('input', debounce(() => renderEstoque(allEstoqueItems), 400));
            
            // Event Listeners for "Total de Itens" tab
            filtroTotalCategoriaEl.addEventListener('change', () => {
                populateTotalItensUnidades();
                renderTotalItens();
            });
            filtroTotalUnidadeEl.addEventListener('change', renderTotalItens);
            filtroTotalEstadoEl.addEventListener('change', renderTotalItens);
            filtroTotalItemEl.addEventListener('input', debounce(renderTotalItens, 400));
            
            openUnidadeModalBtn.addEventListener('click', () => { populateUnidadeModalList(); openUnidadeModal(); });
            closeModalBtn.addEventListener('click', closeUnidadeModal);
            modalOverlay.addEventListener('click', closeUnidadeModal);
            unidadeSearchInput.addEventListener('input', debounce((e) => populateUnidadeModalList(e.target.value), 300));
            unidadeListContainer.addEventListener('click', (e) => {
                const targetLi = e.target.closest('li');
                if (targetLi && targetLi.dataset.value) {
                    selectedUnidadeValue = targetLi.dataset.value;
                    openUnidadeModalBtn.textContent = targetLi.dataset.text;
                    closeUnidadeModal();
                    handleUnidadeChange();
                }
            });
            clearUnidadeSelectionBtn.addEventListener('click', () => {
                selectedUnidadeValue = '';
                openUnidadeModalBtn.textContent = 'Selecione uma Unidade...';
                closeUnidadeModal();
                handleUnidadeChange();
            });
            analiseFilterEl.addEventListener('change', renderNeedsAnalysisReport);
        }

        // --- LÓGICA DO PAINEL DE PRIORIDADES (DASHBOARD) ---
        class PriorityAnalyzer {
            analyze(items) {
                const unitsData = new Map();
                const itemsForAnalysis = items.filter(item => {
                    const type = normalizeString(item.type);
                    const unitCondition = normalizeString(item.unit_condition);
                    return type !== 'sede' && !unitCondition.includes('circo escola');
                });

                itemsForAnalysis.forEach(item => {
                    const unitKey = item.unit_condition;
                    if (!unitsData.has(unitKey)) {
                        unitsData.set(unitKey, {
                            name: formatUnitName(item),
                            items: [],
                            avariados: 0,
                            regulares: 0,
                            totalItems: 0
                        });
                    }
                    const unit = unitsData.get(unitKey);
                    unit.items.push(item);
                    unit.totalItems += item.quantity;
                    if (item.state === 'Avariado') unit.avariados += item.quantity;
                    if (item.state === 'Regular') unit.regulares += item.quantity;
                });

                const allUnits = Array.from(unitsData.values());

                // Lógica de Atenção Proporcional
                allUnits.forEach(u => {
                    if (u.totalItems > 0) {
                        // Peso 3 para avariados, 1 para regulares
                        u.attentionScore = ((u.avariados * 3) + u.regulares) / u.totalItems;
                    } else {
                        u.attentionScore = 0;
                    }
                });
                const attention = allUnits.filter(u => u.attentionScore > 0).sort((a,b) => b.attentionScore - a.attentionScore).slice(0, 10);
                
                // Lógica Bebedouro
                const noBebedouro = allUnits.filter(unit => {
                    const bebedouros = unit.items.filter(item => normalizeString(item.description).includes('bebedouro'));
                    if (bebedouros.length === 0) {
                        return true; // Não tem bebedouro
                    }
                    // Retorna true se NENHUM bebedouro for funcional
                    return !bebedouros.some(b => b.state !== 'Avariado');
                }).slice(0, 10);
                
                return { attention, noBebedouro };
            }
        }
        const priorityAnalyzer = new PriorityAnalyzer();

        function renderDashboard() {
            if (!allItems || allItems.length === 0) {
                document.getElementById('content-dashboard').innerHTML = `<div class="card text-center p-10"><p>Nenhum dado para exibir no dashboard.</p></div>`;
                return;
            }

            // Destruir charts antigos se existirem
            if (dashboardEstadoChartInstance) dashboardEstadoChartInstance.destroy();
            if (dashboardTopItemsChartInstance) dashboardTopItemsChartInstance.destroy();

            // 1. Calcular KPIs
            const totalItens = allItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalUnidades = new Set(allItems.map(item => item.unit_condition)).size;
            const totalAvariados = allItems.filter(i => i.state === 'Avariado').reduce((sum, item) => sum + item.quantity, 0);
            
            const analysis = priorityAnalyzer.analyze(allItems);
            const unidadesAtencao = analysis.attention.length;

            // 2. Renderizar KPIs
            document.getElementById('kpi-total-itens').textContent = totalItens.toLocaleString('pt-BR');
            document.getElementById('kpi-total-unidades').textContent = totalUnidades.toLocaleString('pt-BR');
            document.getElementById('kpi-total-avariados').textContent = totalAvariados.toLocaleString('pt-BR');
            document.getElementById('kpi-unidades-atencao').textContent = unidadesAtencao.toLocaleString('pt-BR');

            // 3. Renderizar Chart de Estado
            const estadoChartCanvas = document.getElementById('dashboardEstadoChart');
            if (estadoChartCanvas) {
                const estadoData = {
                    labels: ['Novo', 'Bom', 'Regular', 'Avariado'],
                    datasets: [{
                        label: 'Quantidade de Itens',
                        data: [
                            allItems.filter(i => i.state === 'Novo').reduce((s, i) => s + i.quantity, 0),
                            allItems.filter(i => i.state === 'Bom').reduce((s, i) => s + i.quantity, 0),
                            allItems.filter(i => i.state === 'Regular').reduce((s, i) => s + i.quantity, 0),
                            totalAvariados
                        ],
                        backgroundColor: [
                            stateColors['Novo'].hex,
                            stateColors['Bom'].hex,
                            stateColors['Regular'].hex,
                            stateColors['Avariado'].hex,
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                };
                const estadoChartConfig = {
                    type: 'doughnut',
                    data: estadoData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: false },
                            legend: { 
                                position: 'right',
                                labels: { color: '#334155' }
                            }
                        }
                    }
                };
                dashboardEstadoChartInstance = new Chart(estadoChartCanvas, estadoChartConfig);
            }

            // 4. Renderizar Chart Top Itens (com agrupamento)
            const topItemsChartCanvas = document.getElementById('dashboardTopItemsChart');
            if (topItemsChartCanvas) {
                // FILTRAR apenas por itens com estado 'Novo'
                const newItems = allItems.filter(item => item.state === 'Novo');

                const itemCounts = newItems.reduce((acc, item) => {
                    const normalizedDescription = normalizeItemDescriptionForChart(item.description);
                    if (normalizedDescription !== 'N/D') {
                       acc[normalizedDescription] = (acc[normalizedDescription] || 0) + item.quantity;
                    }
                    return acc;
                }, {});

                const topItems = Object.entries(itemCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);

                const topItemsData = {
                    labels: topItems.map(item => item[0]),
                    datasets: [{
                        label: 'Quantidade Total',
                        data: topItems.map(item => item[1]),
                        backgroundColor: '#667eea',
                        borderColor: '#4338ca',
                        borderWidth: 1
                    }]
                };
                 const topItemsChartConfig = {
                    type: 'bar',
                    data: topItemsData,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: { // Eixo de valor (horizontal)
                                beginAtZero: true,
                                ticks: { precision: 0, color: '#64748b' },
                                grid: { color: 'rgba(0, 0, 0, 0.1)' }
                            },
                            y: { // Eixo de categoria (vertical)
                                ticks: { color: '#64748b' },
                                grid: { display: false }
                            }
                        }
                    }
                };
                dashboardTopItemsChartInstance = new Chart(topItemsChartCanvas, topItemsChartConfig);
            }

            // 5. Renderizar Listas
            const attentionContainer = document.getElementById('dashboard-attention-units-list');
            if(attentionContainer) attentionContainer.innerHTML = analysis.attention.length > 0 ? analysis.attention.map(u => `<p class="text-sm text-slate-600">${u.name} <span class="font-bold text-yellow-500">(${u.avariados} avariados, ${u.regulares} regulares)</span></p>`).join('') : '<p class="text-sm text-slate-500">Nenhuma unidade em atenção.</p>';
            
            const noBebedouroContainer = document.getElementById('dashboard-no-bebedouro-units-list');
            if(noBebedouroContainer) noBebedouroContainer.innerHTML = analysis.noBebedouro.length > 0 ? analysis.noBebedouro.map(u => `<p class="text-sm text-slate-600">${u.name}</p>`).join('') : '<p class="text-sm text-slate-500">Todas as unidades têm bebedouro funcional.</p>';
        }

        // --- LÓGICA DA ABA SEDE (NOVO LAYOUT) ---
        let currentSedeFilter = 'all';
        let currentSedeFloor = 'Todos';

        function renderSedeReport() {
            const floorNavContainer = document.getElementById('sede-floor-nav');
            const roomsContainer = document.getElementById('sede-rooms-container');
            const noResults = document.getElementById('noResultsSede');
            const searchBox = document.getElementById('searchBoxSede');
            const searchTerm = searchBox.value.toLowerCase();

            // Gerar navegação de andares (apenas uma vez)
            if (floorNavContainer.children.length === 0) {
                const floorOrder = ['Todos', 'SUBSOLO', 'TÉRREO', 'MEZANINO', '1º ANDAR', '2º ANDAR', '3º ANDAR', 'PENDENTE'];
                floorNavContainer.innerHTML = floorOrder.map(floor => {
                    const floorName = floor === 'PENDENTE' ? 'Pendentes' : floor;
                    return `<button class="floor-nav-button ${floor === 'Todos' ? 'active' : ''}" data-floor="${floor}">
                        ${floorName}
                    </button>`;
                }).join('');
                floorNavContainer.querySelectorAll('.floor-nav-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        currentSedeFloor = btn.dataset.floor;
                        floorNavContainer.querySelector('.active').classList.remove('active');
                        btn.classList.add('active');
                        renderSedeReport();
                    });
                });
            }
            
            let filteredData = sedeData.filter(item => {
                const matchFloor = currentSedeFloor === 'Todos' || item.local === currentSedeFloor;
                
                const hasMatchingSector = item.setores.some(setor => 
                    setor.nome.toLowerCase().includes(searchTerm) || 
                    (setor.registro && setor.registro.toLowerCase().includes(searchTerm))
                );

                const matchSearch = searchTerm === '' || 
                    item.sala.toLowerCase().includes(searchTerm) ||
                    item.tipo.toLowerCase().includes(searchTerm) ||
                    item.local.toLowerCase().includes(searchTerm) ||
                    hasMatchingSector;
                
                const matchRegistry = currentSedeFilter !== 'no-registry' || item.setores.some(s => !s.registro || s.observacao);

                return matchFloor && matchSearch && matchRegistry;
            });
            
            if (filteredData.length === 0) {
                roomsContainer.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            roomsContainer.innerHTML = filteredData.map(room => {
                const hasNoRegistry = room.setores.some(s => !s.registro || s.observacao);
                const cardClass = hasNoRegistry ? 'room-card-sede no-registry fade-in' : 'room-card-sede fade-in';

                const setoresHTML = room.setores.map(setor => `
                    <div class="department-item-sede">
                        <p class="department-name-sede">${setor.nome}</p>
                        <p class="department-registro-sede">Registro: ${setor.registro || 'N/A'}</p>
                        ${setor.observacao ? `<p class="department-observacao-sede">${setor.observacao}</p>` : ''}
                    </div>
                `).join('');

                return `
                    <div class="${cardClass}">
                        <div class="room-card-header">
                            <p class="room-card-subtitle">${room.local} - ${room.tipo}</p>
                            <h3 class="room-card-title">${room.sala}</h3>
                        </div>
                        <div class="room-card-body">
                            ${setoresHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }


        function initSedeTab() {
            document.getElementById('searchBoxSede').addEventListener('input', debounce(renderSedeReport, 300));
            document.getElementById('filterAllSede').addEventListener('click', function() {
                currentSedeFilter = 'all';
                document.querySelectorAll('#content-sede .filter-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                renderSedeReport();
            });
            document.getElementById('filterNoRegistrySede').addEventListener('click', function() {
                currentSedeFilter = 'no-registry';
                document.querySelectorAll('#content-sede .filter-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                renderSedeReport();
            });
        }

        // --- INICIALIZAÇÃO GERAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            initApp(); 
            initSedeTab();
            
            const intelligentDashboard = document.getElementById('intelligent-dashboard');
            const loaderHTML = `<div class="card text-center p-10 col-span-full"><div class="loading-spinner"></div><p class="mt-4 text-slate-600">A carregar dados...</p></div>`;
            if(intelligentDashboard) intelligentDashboard.innerHTML = loaderHTML;

            connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-yellow-400 rounded-full animate-pulse"></span> <span>A conectar...</span>`;
            
            try {
                const patrimonioData = await dataManager.fetchWithCache(googleSheetPatrimonioUrl, 'patrimonio');
                if (!patrimonioData || !Array.isArray(patrimonioData)) {
                    throw new Error("Nenhum dado de patrimônio foi retornado. Verifique a planilha e o script.");
                }
                allItems = formatSheetData(patrimonioData);
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-green-500 rounded-full"></span> <span>Conectado</span>`;
                
                updateFilterOptions();
                switchTab('dashboard'); // Inicia na aba Dashboard
                const now = new Date();
                const formattedDate = now.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const updateTimeEl = document.getElementById('last-update-time');
                if (updateTimeEl) {
                    updateTimeEl.textContent = `Dados de ${formattedDate}`;
                }
            } catch (error) {
                console.error('Erro fatal ao inicializar o painel:', error);
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-red-500 rounded-full"></span> <span class="text-red-500">Erro</span>`;
                const errorHTML = `
                    <div class="alert alert-error col-span-full">
                        <h2 class="font-bold">Erro ao Carregar Painel</h2>
                        <p class="mt-2">Não foi possível carregar os dados do patrimônio.</p>
                        <p class="text-sm mt-4"><strong>Detalhes:</strong> ${error.message}</p>
                    </div>`;
                if(intelligentDashboard) intelligentDashboard.innerHTML = errorHTML;
            }
        });
    </script>
</body>
</html>


