<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIRETORIA T√âCNICA DE ALMOXARIFADO E PATRIM√îNIO - SEMCAS</title>
    
    <!-- Scripts e Links -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --light-blue: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        /* Componentes reus√°veis */
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .alert { padding: 1rem; border-radius: 0.5rem; border: 1px solid; }
        .alert-error { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: #d1fae5; color: #059669; }
        .badge-blue { background: #dbeafe; color: #2563eb; }
        .badge-yellow { background: #fef3c7; color: #d97706; }
        .badge-red { background: #fee2e2; color: #dc2626; }

        /* Header */
        .header-banner {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Navega√ß√£o */
        .nav-btn {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #475569;
            white-space: nowrap;
        }
        .nav-btn:hover { background-color: #f8fafc; }
        .nav-btn.active { color: var(--secondary-blue); border-bottom-color: var(--secondary-blue); }

        /* Anima√ß√µes */
        .loading-spinner {
            border: 5px solid #e5e7eb;
            border-top: 5px solid var(--secondary-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: all 0.3s ease; max-height: 90vh; }
        .chart-container { position: relative; width: 100%; height: 350px; }

        /* --- ESTILOS MODERNIZADOS PARA ABA SEDE --- */
        .sede-layout { display: grid; grid-template-columns: 240px 1fr; gap: 2rem; align-items: flex-start; }
        .floor-nav { position: sticky; top: 160px; }
        .floor-nav-button { display: flex; align-items: center; width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; color: #475569; transition: all 0.2s ease; border: 1px solid transparent; }
        .floor-nav-button:hover { background-color: #f8fafc; color: var(--primary-blue); }
        .floor-nav-button.active { background-color: var(--primary-blue); color: white; font-weight: 600; box-shadow: 0 4px 14px rgba(30, 64, 175, 0.3); }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .room-card-sede { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s ease; border-left: 4px solid var(--light-blue); display: flex; flex-direction: column; }
        .room-card-sede.no-registry { border-left-color: var(--warning); }
        .department-item-sede { padding: 0.75rem; background-color: #f8fafc; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 2px solid #e2e8f0; }
        .search-box { width: 100%; padding: 10px 18px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 50px; outline: none; transition: all 0.3s ease; background: #f8fafc; }
        .search-box:focus { border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .filter-btn { padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 50px; background: white; color: #64748b; font-weight: 500; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; }
        .filter-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-color: transparent; }
        
        /* --- ESTILOS PARA NOVA ABA "TOTAL DE ITENS" --- */
        #total-itens-layout { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; align-items: flex-start; }
        #total-itens-list-container { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: calc(100vh - 300px); display: flex; flex-direction: column; }
        #total-itens-list { overflow-y: auto; flex-grow: 1; }
        .total-item-entry { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background-color 0.2s ease; }
        .total-item-entry.selected { background-color: #eef2ff; border-left: 4px solid var(--primary-blue); font-weight: 600; }
        #total-itens-details-container { position: sticky; top: 160px; }
        
        /* --- ESTILOS PARA ABA "NOTA FISCAL" (Layout de Acorde√£o) --- */
        .nf-accordion-item summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            list-style: none; /* Remove a seta padr√£o */
        }
        .nf-accordion-item[open] summary {
            border-bottom: 1px solid #e5e7eb;
        }
        .nf-accordion-item summary::-webkit-details-marker {
            display: none; /* Chrome */
        }
        .nf-accordion-item summary::after {
            content: '‚ñº';
            font-size: 0.8em;
            transition: transform 0.3s ease;
            margin-left: 1rem;
        }
        .nf-accordion-item[open] summary::after {
            transform: rotate(180deg);
        }
        .nf-details-content {
             padding: 1.5rem;
        }
        .kpi-nf { text-align: center; padding: 1rem; background-color: #f8fafc; border-radius: 0.5rem; }
        .kpi-nf .value { font-size: 1.75rem; font-weight: 700; color: var(--primary-blue); }
        .kpi-nf .label { font-size: 0.8rem; color: #64748b; text-transform: uppercase; }

        /* --- RESPONSIVIDADE GERAL --- */
        @media (max-width: 1024px) {
            .sede-layout, #total-itens-layout { grid-template-columns: 1fr; }
            .floor-nav, #total-itens-details-container { position: static; }
            .floor-nav { display: flex; overflow-x: auto; padding-bottom: 1rem; gap: 0.5rem; }
            #total-itens-list-container { height: auto; max-height: 400px; }
        }
    </style>
</head>
<body class="text-slate-700 antialiased">

    <!-- Header -->
    <header class="header-banner sticky top-0 z-50 text-white p-4">
        <div class="container mx-auto flex items-center gap-4">
            <img src="https://www.saoluis.ma.gov.br/img/logo_mobile.png" alt="Logo Prefeitura" class="h-14 bg-white p-1 rounded-md shadow-md">
            <div>
                <h1 class="text-xl md:text-2xl font-bold leading-tight">Diretoria de Almoxarifado e Patrim√¥nio</h1>
                <p class="text-sm opacity-90">SEMCAS - S√£o Lu√≠s</p>
            </div>
        </div>
    </header>

    <!-- Sub-Header de Status -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h2 class="font-bold text-lg text-slate-800">Sistema de Patrim√¥nio <span class="text-sm font-normal">v.3.1</span></h2>
            <div class="flex items-center space-x-4 text-sm">
                <div id="connectionStatus" class="flex items-center gap-2 font-semibold"></div>
                <p id="last-update-time" class="text-slate-500 hidden md:block"></p>
            </div>
        </div>
    </div>

    <!-- Navega√ß√£o por Abas -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky z-40 top-[92px] md:top-[88px]">
        <div class="container mx-auto px-4">
            <div class="flex space-x-1 overflow-x-auto">
                <button class="nav-btn" data-tab="dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-tab="patrimonio">üíº Patrim√¥nio</button>
                <button class="nav-btn" data-tab="estoque">üì¶ Estoque</button>
                <button class="nav-btn" data-tab="nota-fiscal">üßæ Nota Fiscal</button>
                <button class="nav-btn" data-tab="total-itens">üî¢ Total de Itens</button>
                <button class="nav-btn" data-tab="sede">üè¢ Sede</button>
            </div>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Dashboard -->
        <div id="content-dashboard" class="hidden fade-in">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card text-center"><p class="text-sm text-slate-500 uppercase">Total de Itens</p><p id="kpi-total-itens" class="text-4xl font-bold text-blue-600 mt-2">0</p></div>
                <div class="card text-center"><p class="text-sm text-slate-500 uppercase">Unidades Mapeadas</p><p id="kpi-total-unidades" class="text-4xl font-bold text-blue-600 mt-2">0</p></div>
                <div class="card text-center"><p class="text-sm text-slate-500 uppercase">Itens Avariados</p><p id="kpi-total-avariados" class="text-4xl font-bold text-red-600 mt-2">0</p></div>
                <div class="card text-center"><p class="text-sm text-slate-500 uppercase">Unidades em Aten√ß√£o</p><p id="kpi-unidades-atencao" class="text-4xl font-bold text-yellow-500 mt-2">0</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 card"><h3 class="text-lg font-semibold text-slate-800 mb-4">Distribui√ß√£o por Estado</h3><div class="chart-container" style="height: 400px;"><canvas id="dashboardEstadoChart"></canvas></div></div>
                <div class="card"><h3 class="text-lg font-semibold text-slate-800 mb-4">‚ö†Ô∏è Top Unidades em Aten√ß√£o</h3><div id="dashboard-attention-units-list" class="space-y-3 overflow-y-auto" style="max-height: 350px;"></div></div>
            </div>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                 <div class="lg:col-span-2 card"><h3 class="text-lg font-semibold text-slate-800 mb-4">Top 10 Itens Novos</h3><div class="chart-container" style="height: 400px;"><canvas id="dashboardTopItemsChart"></canvas></div></div>
                <div class="card"><h3 class="text-lg font-semibold text-slate-800 mb-4">üíß Unidades sem Bebedouro</h3><div id="dashboard-no-bebedouro-units-list" class="space-y-3 overflow-y-auto" style="max-height: 350px;"></div></div>
            </div>
        </div>

        <!-- Patrim√¥nio -->
        <div id="content-patrimonio" class="hidden fade-in">
             <div class="card mb-8">
                <!-- Linha 1: Filtros principais -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div><label for="filtro-servico" class="block text-sm font-medium mb-1">Tipo</label><select id="filtro-servico" class="w-full p-2 border rounded-lg"><option value="">TODOS</option><option value="conselho">CONSELHO</option><option value="cras">CRAS</option><option value="creas">CREAS</option><option value="externa">UNIDADE EXTERNA</option><option value="centro_pop">CENTRO POP</option><option value="abrigo">ABRIGO</option><option value="sede">SEDE</option></select></div>
                    <div><label for="open-unidade-modal-btn" class="block text-sm font-medium mb-1">Unidade</label><button id="open-unidade-modal-btn" class="w-full p-2 border rounded-lg text-left truncate disabled:opacity-50">Selecione...</button></div>
                    <div><label for="filtro-estado" class="block text-sm font-medium mb-1">Estado</label><select id="filtro-estado" class="w-full p-2 border rounded-lg"></select></div>
                    <div><label for="filtro-doacao" class="block text-sm font-medium mb-1">Origem</label><select id="filtro-doacao" class="w-full p-2 border rounded-lg"><option value="">TODAS</option><option value="sim">DOA√á√ïES</option><option value="nao">PR√ìPRIOS</option></select></div>
                </div>
                <!-- Linha 2: Busca e bot√£o de filtros avan√ßados -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="filtro-busca" class="block text-sm font-medium mb-1">Busca Geral</label>
                        <input type="text" id="filtro-busca" placeholder="Buscar em todos os campos..." class="w-full p-2 border rounded-lg">
                    </div>
                    <div class="self-end">
                        <button id="toggle-advanced-filters-btn" class="w-full p-2 border border-slate-300 font-semibold rounded-lg hover:bg-slate-100 transition h-[42px]">Filtros Avan√ßados</button>
                    </div>
                </div>
                <!-- Linha 3: Filtros avan√ßados (escondidos por padr√£o) -->
                <div id="advanced-filters-container" class="hidden mt-4 pt-4 border-t border-slate-200">
                    <p class="text-sm font-semibold mb-3 text-slate-600">Filtros Espec√≠ficos:</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div><label for="filtro-tombamento" class="block text-sm font-medium mb-1">Tombamento</label><input type="text" id="filtro-tombamento" placeholder="Filtrar por tomb..." class="w-full p-2 border rounded-lg"></div>
                        <div><label for="filtro-descricao" class="block text-sm font-medium mb-1">Descri√ß√£o</label><input type="text" id="filtro-descricao" placeholder="Filtrar por desc..." class="w-full p-2 border rounded-lg"></div>
                        <div><label for="filtro-local" class="block text-sm font-medium mb-1">Local na Unidade</label><input type="text" id="filtro-local" placeholder="Filtrar por local..." class="w-full p-2 border rounded-lg"></div>
                        <div><label for="filtro-fornecedor" class="block text-sm font-medium mb-1">Fornecedor</label><input type="text" id="filtro-fornecedor" placeholder="Filtrar por forn..." class="w-full p-2 border rounded-lg"></div>
                        <div class="sm:col-span-2"><label for="filtro-observacao" class="block text-sm font-medium mb-1">Observa√ß√£o</label><input type="text" id="filtro-observacao" placeholder="Filtrar por obs..." class="w-full p-2 border rounded-lg"></div>
                    </div>
                </div>
                <!-- Linha 4: Bot√£o de Resumo Geral -->
                <div class="mt-6">
                    <button id="ver-resumo-geral-btn" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">VER INVENT√ÅRIO COMPLETO</button>
                </div>
            </div>
            <main id="main-content-area" class="mt-8"></main>
        </div>

        <!-- Estoque -->
        <div id="content-estoque" class="hidden fade-in">
             <div class="card mb-8">
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                    <div><label for="filtro-estoque-unidade" class="block text-sm font-medium mb-1">Unidade</label><select id="filtro-estoque-unidade" class="w-full p-2 border rounded-lg"></select></div>
                    <div><label for="filtro-estoque-busca" class="block text-sm font-medium mb-1">Buscar</label><input type="text" id="filtro-estoque-busca" placeholder="Ex: Caf√©, Papel A4..." class="w-full p-2 border rounded-lg"></div>
                 </div>
            </div>
            <div class="card mb-8"><h3 class="text-lg font-semibold mb-4">TOP 10 ITENS EM ESTOQUE</h3><div class="chart-container"><canvas id="estoqueBarChart"></canvas></div></div>
            <main id="main-content-estoque" class="mt-8"></main>
        </div>

        <!-- Nota Fiscal -->
        <div id="content-nota-fiscal" class="hidden fade-in">
            <div class="card mb-6">
                <h2 class="text-2xl font-bold text-slate-800">An√°lise de Notas Fiscais</h2>
                <p class="text-slate-500 mt-1">Clique em uma nota para expandir os detalhes.</p>
            </div>
            <div id="nf-accordion-container">
                <!-- Acorde√£o de Notas Fiscais ser√° renderizado aqui -->
            </div>
        </div>
        
        <!-- Total de Itens -->
        <div id="content-total-itens" class="hidden fade-in">
            <div class="card mb-8"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label for="filtro-total-categoria" class="block text-sm font-medium mb-1">Categoria</label><select id="filtro-total-categoria" class="w-full p-2 border rounded-lg"></select></div><div><label for="filtro-total-item" class="block text-sm font-medium mb-1">Buscar Item</label><input type="text" id="filtro-total-item" placeholder="Ex: Fog√£o..." class="w-full p-2 border rounded-lg"></div><div><label for="filtro-total-unidade" class="block text-sm font-medium mb-1">Unidade</label><select id="filtro-total-unidade" class="w-full p-2 border rounded-lg"></select></div><div><label for="filtro-total-estado" class="block text-sm font-medium mb-1">Estado</label><select id="filtro-total-estado" class="w-full p-2 border rounded-lg"></select></div></div></div>
            <main id="total-itens-layout">
                <div id="total-itens-list-container"><div class="p-4 border-b"><h3 class="font-semibold">Itens Agrupados</h3><p class="text-sm text-slate-500" id="total-itens-list-count">0</p></div><div id="total-itens-list"></div></div>
                <div id="total-itens-details-container"></div>
            </main>
        </div>
        
        <!-- Sede -->
        <div id="content-sede" class="hidden fade-in">
            <div class="card mb-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center"><input type="text" class="search-box" id="searchBoxSede" placeholder="üîç Pesquisar por setor, sala..."><div class="flex items-center space-x-2"><label class="text-sm font-medium">Filtro:</label><button class="filter-btn active" id="filterAllSede">Todas</button><button class="filter-btn" id="filterNoRegistrySede">Pendentes</button></div></div></div>
            <div class="sede-layout">
                <nav id="sede-floor-nav" class="floor-nav space-y-2"></nav>
                <div id="sede-rooms-container" class="room-grid"></div>
            </div>
            <div id="noResultsSede" style="display: none;" class="text-center card mt-6"><h3 class="text-xl font-bold">Nenhum resultado encontrado</h3><p>Tente ajustar sua pesquisa ou filtros.</p></div>
        </div>
    </main>

    <!-- Rodap√© -->
    <footer class="text-center mt-12 mb-6 text-sm text-slate-500">
        <p>Painel desenvolvido por: Jurandy | SEMCAS</p>
    </footer>

    <!-- Modal de Sele√ß√£o de Unidade -->
    <div id="unidade-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black/60 opacity-0"></div>
        <div class="modal-container bg-white w-full max-w-2xl rounded-lg shadow-2xl flex flex-col transform scale-95 opacity-0">
            <div class="flex items-center justify-between p-4 border-b"><h3 class="text-xl font-semibold">Selecionar Unidade</h3><button id="close-modal-btn" class="p-2 rounded-full hover:bg-slate-200">&times;</button></div>
            <div class="p-4 border-b"><input type="text" id="unidade-search-input" placeholder="Pesquisar..." class="w-full p-2 border rounded-lg"></div>
            <div class="p-4 overflow-y-auto flex-1"><ul id="unidade-list-container" class="space-y-2"></ul></div>
            <div class="flex justify-end p-4 border-t"><button id="clear-unidade-selection-btn" class="px-4 py-2 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">Limpar Sele√ß√£o</button></div>
        </div>
    </div>

    <script type="module" src="./main.js"></script>
</body>
</html>
